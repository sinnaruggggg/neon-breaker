<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NEON BREAKER</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#00f0ff;--secondary:#ff00aa;--accent:#ffdd00;--success:#00ff88;
      --gem:#a855f7;--gem-glow:rgba(168,85,247,0.5);
      --bg:#030308;--card:rgba(15,15,30,0.9);--text:#fff;--text-dim:#5a6a8a
    }
    *{margin:0;padding:0;box-sizing:border-box;user-select:none}
    html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);touch-action:none}
    
    #app{width:100%;height:100%;display:flex;flex-direction:column;position:relative;overflow:hidden}
    #app::before{content:'';position:absolute;inset:0;background:
      radial-gradient(ellipse at 50% 0%,rgba(0,240,255,0.08) 0%,transparent 50%),
      radial-gradient(ellipse at 80% 80%,rgba(255,0,170,0.05) 0%,transparent 40%);pointer-events:none}
    #app::after{content:'';position:absolute;inset:0;background:
      linear-gradient(90deg,transparent 0%,transparent calc(50% - 1px),rgba(0,240,255,0.03) 50%,transparent calc(50% + 1px),transparent 100%),
      linear-gradient(0deg,transparent 0%,transparent calc(50% - 1px),rgba(0,240,255,0.03) 50%,transparent calc(50% + 1px),transparent 100%);
      background-size:60px 60px;pointer-events:none;animation:gridMove 20s linear infinite}
    @keyframes gridMove{0%{transform:translate(0,0)}100%{transform:translate(60px,60px)}}
    
    #header{height:50px;padding:0 10px;background:linear-gradient(180deg,rgba(0,0,0,0.95) 0%,rgba(0,0,0,0.7) 70%,transparent 100%);display:flex;align-items:center;justify-content:space-between;position:relative;z-index:10;border-bottom:1px solid rgba(0,240,255,0.2)}
    #header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--primary),var(--secondary),var(--primary),transparent)}
    .hud-group{display:flex;align-items:center;gap:10px}
    .hud-stat{display:flex;flex-direction:column;align-items:center}
    .hud-stat .label{font-size:7px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
    .hud-stat .value{font-family:'Orbitron';font-size:13px;font-weight:700;color:var(--primary);text-shadow:0 0 10px var(--primary)}
    .hud-stat .value.gold{color:var(--accent);text-shadow:0 0 10px var(--accent)}
    .hud-stat .value.gem{color:var(--gem);text-shadow:0 0 10px var(--gem)}
    .currency-icon{font-size:11px;margin-right:2px}
    .lives-bar{display:flex;gap:3px}
    .heart{width:12px;height:11px;background:linear-gradient(135deg,#ff5577,#ff2255);clip-path:polygon(50% 0%,100% 35%,80% 100%,50% 75%,20% 100%,0% 35%);filter:drop-shadow(0 0 4px #ff2255)}
    .heart.empty{background:#222;filter:none}
    #pauseBtn{width:36px;height:36px;background:rgba(0,240,255,0.05);border:1px solid rgba(0,240,255,0.4);border-radius:8px;color:var(--primary);font-size:12px;display:flex;align-items:center;justify-content:center}
    
    #gameArea{flex:1;position:relative;overflow:hidden}
    #gameCanvas{width:100%;height:100%;display:block}
    
    /* Ïª®Ìä∏Î°§ - 2Î∞∞ Îçî ÌÅ¨Í≤å */
    #controls{height:200px;padding:8px 10px;background:linear-gradient(0deg,rgba(0,0,0,0.98) 0%,rgba(5,5,15,0.95) 80%,transparent 100%);border-top:1px solid rgba(0,240,255,0.2);position:relative;z-index:10}
    #controls::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--primary),var(--secondary),var(--primary),transparent)}
    #skillBar{display:flex;justify-content:center;gap:10px;margin-bottom:8px}
    .skill-btn{width:44px;height:44px;background:linear-gradient(135deg,rgba(20,20,40,0.9),rgba(10,10,25,0.9));border:2px solid rgba(100,100,150,0.3);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;opacity:0.4}
    .skill-btn.unlocked{opacity:1;border-color:var(--secondary);box-shadow:0 0 15px rgba(255,0,170,0.2)}
    .skill-btn .icon{font-size:18px}
    .skill-btn .lvl{font-family:'Orbitron';font-size:7px;color:var(--accent)}
    .skill-btn .cd-fill{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.85);height:0%}
    #moveBar{display:flex;justify-content:space-between;align-items:center;padding:0 5px}
    /* Î∞©Ìñ•ÌÇ§ 2Î∞∞ */
    .dir-btn{width:110px;height:110px;background:linear-gradient(135deg,rgba(0,240,255,0.1),rgba(0,150,200,0.05));border:3px solid var(--primary);border-radius:50%;color:var(--primary);font-size:40px;display:flex;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(0,240,255,0.3),inset 0 0 40px rgba(0,240,255,0.1)}
    .dir-btn:active{background:rgba(0,240,255,0.3);box-shadow:0 0 50px rgba(0,240,255,0.6)}
    /* Î∞úÏÇ¨Î≤ÑÌäº 2Î∞∞ */
    #fireBtn{width:130px;height:130px;background:linear-gradient(145deg,#ff0066,#aa0044);border:4px solid #ff4488;border-radius:50%;font-family:'Orbitron';font-size:16px;font-weight:900;color:#fff;box-shadow:0 0 50px rgba(255,0,102,0.6),inset 0 0 40px rgba(255,255,255,0.1)}
    #fireBtn:active{transform:scale(0.95);box-shadow:0 0 70px rgba(255,0,102,0.8)}
    
    .overlay{position:fixed;inset:0;background:rgba(3,3,8,0.98);display:flex;flex-direction:column;align-items:center;padding:15px;overflow-y:auto;z-index:100}
    .overlay.hidden{display:none}
    .overlay::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 20%,rgba(0,240,255,0.1) 0%,transparent 50%);pointer-events:none}
    .overlay-inner{width:100%;max-width:400px;display:flex;flex-direction:column;align-items:center;position:relative;z-index:1}
    
    .brand{margin:20px 0;text-align:center}
    .brand h1{font-family:'Orbitron';font-size:32px;font-weight:900;background:linear-gradient(135deg,var(--primary) 0%,#fff 50%,var(--secondary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:drop-shadow(0 0 25px rgba(0,240,255,0.5))}
    .brand p{font-family:'Share Tech Mono';font-size:9px;color:var(--primary);letter-spacing:8px;margin-top:5px}
    
    .currency-display{display:flex;gap:12px;margin:12px 0}
    .currency-badge{display:flex;align-items:center;gap:6px;padding:8px 16px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.1);border-radius:20px}
    .currency-badge.coin{border-color:rgba(255,220,0,0.3)}
    .currency-badge.gem{border-color:rgba(168,85,247,0.3)}
    .currency-badge .icon{font-size:16px}
    .currency-badge .amount{font-family:'Orbitron';font-size:14px;font-weight:700}
    .currency-badge.coin .amount{color:var(--accent)}
    .currency-badge.gem .amount{color:var(--gem)}
    
    .btn{width:100%;max-width:280px;padding:14px 24px;margin:6px 0;font-family:'Orbitron';font-size:11px;font-weight:700;border:none;border-radius:8px;cursor:pointer;text-transform:uppercase;letter-spacing:2px;transition:all 0.2s}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#0088bb);color:#000;box-shadow:0 0 25px rgba(0,240,255,0.4)}
    .btn-secondary{background:linear-gradient(135deg,var(--secondary),#880055);color:#fff;box-shadow:0 0 25px rgba(255,0,170,0.4)}
    .btn-gold{background:linear-gradient(135deg,var(--accent),#cc9900);color:#000}
    .btn-gem{background:linear-gradient(135deg,var(--gem),#7c3aed);color:#fff}
    .btn-ghost{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.2);color:var(--text-dim)}
    .btn:hover{transform:translateY(-2px)}
    
    /* Ïä§ÌÖåÏù¥ÏßÄ Îßµ */
    .stage-map{position:relative;width:100%;height:400px;border-radius:12px;overflow:hidden;margin:15px 0;background:#111}
    .stage-map-bg{position:absolute;inset:0;background-size:cover;background-position:center}
    .stage-map-bg img{width:100%;height:100%;object-fit:cover}
    .stage-node{position:absolute;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'Orbitron';font-size:14px;font-weight:700;cursor:pointer;transition:all 0.2s;transform:translate(-50%,-50%)}
    .stage-node.locked{background:rgba(50,50,60,0.8);border:2px solid #444;color:#666;cursor:not-allowed}
    .stage-node.cleared{background:linear-gradient(135deg,var(--success),#00aa55);border:2px solid var(--success);color:#000;box-shadow:0 0 20px rgba(0,255,136,0.5)}
    .stage-node.current{background:linear-gradient(135deg,var(--primary),#0088aa);border:3px solid #fff;color:#000;box-shadow:0 0 30px rgba(0,240,255,0.7);animation:currentPulse 1.5s infinite}
    .stage-node.boss{background:linear-gradient(135deg,var(--gem),#7c3aed);border:2px solid var(--gem)}
    .stage-node.boss.locked{background:rgba(80,40,100,0.5);border-color:#553}
    @keyframes currentPulse{0%,100%{transform:translate(-50%,-50%) scale(1)}50%{transform:translate(-50%,-50%) scale(1.1)}}
    .stage-line{position:absolute;height:3px;background:rgba(255,255,255,0.2);transform-origin:left center}
    .stage-line.active{background:linear-gradient(90deg,var(--success),var(--primary))}
    .round-selector{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;justify-content:center}
    .round-btn{padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;font-family:'Orbitron';font-size:10px;color:var(--text-dim);cursor:pointer}
    .round-btn.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .round-btn.locked{opacity:0.4;cursor:not-allowed}
    
    /* ÏÉÅÏ†ê */
    .shop-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;justify-content:center}
    .shop-tab{padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;font-family:'Orbitron';font-size:9px;color:var(--text-dim);cursor:pointer}
    .shop-tab.active{background:rgba(0,240,255,0.1);color:var(--primary);border-color:var(--primary)}
    .shop-list{width:100%;max-height:280px;overflow-y:auto}
    .shop-item{display:flex;align-items:center;padding:12px;margin-bottom:8px;background:linear-gradient(135deg,rgba(15,15,35,0.9),rgba(10,10,25,0.9));border:1px solid rgba(255,255,255,0.08);border-radius:10px}
    .shop-item.locked{opacity:0.4}
    .shop-item.maxed{border-color:var(--success)}
    .shop-item .icon-box{width:46px;height:46px;background:linear-gradient(135deg,rgba(0,240,255,0.15),rgba(255,0,170,0.15));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-right:12px}
    .shop-item .info{flex:1}
    .shop-item .name{font-family:'Orbitron';font-size:11px;color:#fff}
    .shop-item .desc{font-size:9px;color:var(--text-dim)}
    .shop-item .level{font-family:'Orbitron';font-size:8px;color:var(--accent);margin-top:3px}
    .level-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:4px;overflow:hidden}
    .level-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary))}
    .shop-btn{padding:8px 12px;font-family:'Orbitron';font-size:8px;border:none;border-radius:6px;cursor:pointer}
    .shop-btn-buy{background:var(--accent);color:#000}
    .shop-btn-buy:disabled{background:#333;color:#666}
    .shop-btn-max{background:rgba(0,255,136,0.2);color:var(--success)}
    
    /* Í∞§Îü¨Î¶¨ */
    .gallery-section{width:100%;margin-bottom:20px}
    .gallery-section-title{font-family:'Orbitron';font-size:12px;color:var(--secondary);padding:8px 0;border-bottom:1px solid rgba(255,0,170,0.3);margin-bottom:10px}
    .gallery-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .gallery-item{aspect-ratio:1;background:rgba(15,15,35,0.9);border:2px solid rgba(255,255,255,0.1);border-radius:10px;overflow:hidden;cursor:pointer;position:relative}
    .gallery-item:hover{border-color:var(--primary)}
    .gallery-item.locked{opacity:0.25;cursor:not-allowed}
    .gallery-item.locked::after{content:'üîí';position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:18px;background:rgba(0,0,0,0.7)}
    .gallery-item img{width:100%;height:100%;object-fit:cover}
    .gallery-item .gallery-label{position:absolute;bottom:0;left:0;right:0;padding:4px;background:linear-gradient(transparent,rgba(0,0,0,0.9));font-family:'Orbitron';font-size:8px;color:var(--primary);text-align:center}
    .gallery-item .has-video{position:absolute;top:4px;right:4px;width:18px;height:18px;background:var(--gem);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px}
    .gallery-scroll{max-height:380px;overflow-y:auto;width:100%}
    
    .gallery-view{position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:300;display:flex;flex-direction:column}
    .gallery-view.hidden{display:none}
    .gallery-view-bg{flex:1;display:flex;align-items:center;justify-content:center;padding:15px}
    .gallery-view-bg img,.gallery-view-bg video{max-width:100%;max-height:100%;object-fit:contain;border-radius:10px}
    .gallery-view-info{padding:15px;background:linear-gradient(transparent,rgba(0,0,0,0.98))}
    .gallery-view-title{font-family:'Orbitron';font-size:13px;color:var(--primary);margin-bottom:8px}
    .gallery-view-text{font-family:'Share Tech Mono';font-size:12px;color:var(--text);line-height:1.6;max-height:70px;overflow-y:auto}
    .gallery-close{position:absolute;top:15px;right:15px;width:40px;height:40px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:50%;color:#fff;font-size:18px;cursor:pointer;z-index:10}
    .gallery-video-btn{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);padding:10px 25px;background:linear-gradient(135deg,var(--gem),#7c3aed);border:none;border-radius:20px;font-family:'Orbitron';font-size:10px;color:#fff;cursor:pointer}
    .gallery-video-btn:disabled{background:#333}
    
    /* Ïä§ÌÖåÏù¥ÏßÄ ÌÅ¥Î¶¨Ïñ¥ */
    .stage-clear-overlay{position:fixed;inset:0;background:#000;z-index:200;display:flex;flex-direction:column}
    .stage-clear-overlay.hidden{display:none}
    .stage-clear-bg{position:absolute;inset:0}
    .stage-clear-bg img,.stage-clear-bg video{width:100%;height:100%;object-fit:cover}
    .stage-clear-content{position:relative;z-index:1;flex:1;display:flex;flex-direction:column;justify-content:flex-end}
    
    .story-container{background:linear-gradient(to top,rgba(0,0,0,0.98) 0%,rgba(0,0,0,0.9) 60%,transparent 100%);padding:80px 20px 20px}
    .story-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid rgba(0,240,255,0.15)}
    .story-title{font-family:'Orbitron';font-size:14px;color:var(--primary)}
    .story-rewards{display:flex;gap:12px}
    .story-reward{font-family:'Orbitron';font-size:12px}
    .story-reward.coin{color:var(--accent)}
    .story-reward.gem{color:var(--gem)}
    
    .story-text-box{background:rgba(0,30,40,0.7);border:1px solid rgba(0,240,255,0.25);border-radius:8px;padding:15px;margin-bottom:15px;min-height:70px;position:relative}
    .story-text-box::before{content:'';position:absolute;top:8px;left:8px;width:6px;height:6px;background:var(--primary);border-radius:50%;animation:blink 1s infinite}
    @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:0.3}}
    .story-text{font-family:'Share Tech Mono';font-size:13px;line-height:1.7;color:var(--text);padding-left:15px}
    .story-cursor{display:inline-block;width:8px;height:14px;background:var(--primary);margin-left:2px;animation:cursorBlink 0.5s infinite}
    @keyframes cursorBlink{0%,50%{opacity:1}51%,100%{opacity:0}}
    
    .stage-clear-btn{width:100%;padding:16px;font-family:'Orbitron';font-size:13px;font-weight:700;background:linear-gradient(135deg,var(--primary),#0088bb);color:#000;border:none;border-radius:10px;cursor:pointer;text-transform:uppercase;letter-spacing:3px;box-shadow:0 0 35px rgba(0,240,255,0.5);opacity:0;pointer-events:none;transition:opacity 0.3s}
    .stage-clear-btn.visible{opacity:1;pointer-events:auto}
    
    .gem-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(20,10,40,0.98),rgba(10,5,25,0.98));border:2px solid var(--gem);border-radius:16px;padding:25px;text-align:center;z-index:400;min-width:250px}
    .gem-popup.hidden{display:none}
    .gem-popup h3{font-family:'Orbitron';font-size:16px;color:var(--gem);margin-bottom:12px}
    .gem-popup .gem-icon{font-size:40px;margin:12px 0}
    .gem-popup p{font-size:13px;color:var(--text-dim);margin-bottom:15px}
    .gem-popup .btn{max-width:180px;margin:5px auto}
    
    #toast{position:fixed;bottom:220px;left:50%;transform:translateX(-50%) translateY(50px);padding:12px 25px;background:rgba(5,5,15,0.95);border:1px solid var(--primary);border-radius:25px;font-family:'Orbitron';font-size:10px;color:var(--primary);opacity:0;transition:all 0.3s;z-index:999;pointer-events:none}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div id="app">
    <div id="header">
      <div class="hud-group">
        <div class="hud-stat"><span class="label">Stage</span><span class="value" id="hudRound">1-1</span></div>
        <div class="hud-stat"><span class="label">Score</span><span class="value" id="hudScore">0</span></div>
      </div>
      <div class="hud-stat"><span class="label">Life</span><div class="lives-bar" id="livesBar"></div></div>
      <div class="hud-group">
        <div class="hud-stat"><span class="value gold"><span class="currency-icon">ü™ô</span><span id="hudCoins">0</span></span></div>
        <div class="hud-stat"><span class="value gem"><span class="currency-icon">üíé</span><span id="hudGems">0</span></span></div>
        <button id="pauseBtn">‚ùö‚ùö</button>
      </div>
    </div>
    <div id="gameArea"><canvas id="gameCanvas"></canvas></div>
    <div id="controls">
      <div id="skillBar">
        <button class="skill-btn" id="skill1"><span class="icon">üî•</span><span class="lvl" id="skill1Lvl">-</span><div class="cd-fill" id="cd1"></div></button>
        <button class="skill-btn" id="skill2"><span class="icon">‚ö°</span><span class="lvl" id="skill2Lvl">-</span><div class="cd-fill" id="cd2"></div></button>
        <button class="skill-btn" id="skill3"><span class="icon">üí•</span><span class="lvl" id="skill3Lvl">-</span><div class="cd-fill" id="cd3"></div></button>
        <button class="skill-btn" id="skill4"><span class="icon">‚è±Ô∏è</span><span class="lvl" id="skill4Lvl">-</span><div class="cd-fill" id="cd4"></div></button>
      </div>
      <div id="moveBar">
        <button class="dir-btn" id="leftBtn">‚óÄ</button>
        <button id="fireBtn">FIRE</button>
        <button class="dir-btn" id="rightBtn">‚ñ∂</button>
      </div>
    </div>

    <!-- Start Screen -->
    <div class="overlay" id="startScreen"><div class="overlay-inner">
      <div class="brand"><h1>NEON BREAKER</h1><p>ARCADE</p></div>
      <div class="currency-display">
        <div class="currency-badge coin"><span class="icon">ü™ô</span><span class="amount" id="menuCoins">0</span></div>
        <div class="currency-badge gem"><span class="icon">üíé</span><span class="amount" id="menuGems">0</span></div>
      </div>
      <button class="btn btn-primary" id="startBtn">‚ñ∂ STAGE SELECT</button>
      <button class="btn btn-gold" id="shopBtn">üõí SHOP</button>
      <button class="btn btn-secondary" id="galleryBtn">üñºÔ∏è GALLERY</button>
      <button class="btn btn-gem" id="adBtn">üì∫ AD (+3üíé)</button>
    </div></div>

    <!-- Stage Map -->
    <div class="overlay hidden" id="stageMapScreen"><div class="overlay-inner" style="max-width:100%;padding:0 10px;">
      <div class="brand" style="margin:15px 0 10px;"><h1 style="font-size:22px;">STAGE SELECT</h1></div>
      <div class="round-selector" id="roundSelector"></div>
      <div class="stage-map" id="stageMap">
        <div class="stage-map-bg" id="stageMapBg"></div>
        <div id="stageNodes"></div>
      </div>
      <button class="btn btn-ghost" id="mapBackBtn">‚Üê BACK</button>
    </div></div>

    <!-- Shop -->
    <div class="overlay hidden" id="shopScreen"><div class="overlay-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:12px;">
        <div class="brand" style="margin:0;"><h1 style="font-size:22px;">SHOP</h1></div>
        <div class="currency-badge coin" style="padding:6px 12px;"><span class="icon">ü™ô</span><span class="amount" id="shopCoins">0</span></div>
      </div>
      <div class="shop-tabs">
        <button class="shop-tab active" data-tab="weapon">üî´ WPN</button>
        <button class="shop-tab" data-tab="skill">‚ú® SKL</button>
        <button class="shop-tab" data-tab="paddle">üèì PDL</button>
        <button class="shop-tab" data-tab="ball">‚ö™ BALL</button>
      </div>
      <div class="shop-list" id="shopList"></div>
      <button class="btn btn-ghost" id="closeShopBtn">‚Üê BACK</button>
    </div></div>

    <!-- Gallery -->
    <div class="overlay hidden" id="galleryScreen"><div class="overlay-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:8px;">
        <div class="brand" style="margin:0;"><h1 style="font-size:22px;">GALLERY</h1></div>
        <div class="currency-badge gem" style="padding:6px 12px;"><span class="icon">üíé</span><span class="amount" id="galleryGems">0</span></div>
      </div>
      <div class="gallery-scroll" id="galleryScroll"></div>
      <button class="btn btn-ghost" id="closeGalleryBtn">‚Üê BACK</button>
    </div></div>

    <!-- Gallery View -->
    <div class="gallery-view hidden" id="galleryView">
      <button class="gallery-close" id="galleryCloseBtn">‚úï</button>
      <div class="gallery-view-bg" id="galleryViewBg"><img id="galleryViewImg" src=""></div>
      <button class="gallery-video-btn hidden" id="galleryVideoBtn">üíé 3 VIDEO</button>
      <div class="gallery-view-info">
        <div class="gallery-view-title" id="galleryViewTitle"></div>
        <div class="gallery-view-text" id="galleryViewText"></div>
      </div>
    </div>

    <!-- Pause -->
    <div class="overlay hidden" id="pauseScreen"><div class="overlay-inner">
      <div class="brand"><h1>PAUSED</h1></div>
      <button class="btn btn-primary" id="resumeBtn">‚ñ∂ RESUME</button>
      <button class="btn btn-gold" id="pauseShopBtn">üõí SHOP</button>
      <button class="btn btn-ghost" id="restartBtn">‚Üª RESTART</button>
      <button class="btn btn-ghost" id="menuBtn">‚åÇ MENU</button>
    </div></div>

    <!-- Game Over -->
    <div class="overlay hidden" id="gameOverScreen"><div class="overlay-inner">
      <div class="brand"><h1>GAME OVER</h1></div>
      <div class="currency-display">
        <div class="currency-badge coin"><span class="icon">ü™ô</span><span class="amount" id="earnedCoins">0</span></div>
        <div class="currency-badge gem"><span class="icon">üíé</span><span class="amount" id="earnedGems">0</span></div>
      </div>
      <p style="color:var(--text-dim);margin:10px;">Score: <span id="finalScore" style="color:var(--primary);font-family:Orbitron;">0</span></p>
      <button class="btn btn-primary" id="retryBtn">‚Üª RETRY</button>
      <button class="btn btn-ghost" id="gameOverMenuBtn">‚åÇ MENU</button>
    </div></div>

    <!-- Stage Clear -->
    <div class="stage-clear-overlay hidden" id="stageClearScreen">
      <div class="stage-clear-bg" id="stageClearBg"></div>
      <div class="stage-clear-content">
        <div class="story-container">
          <div class="story-header">
            <span class="story-title" id="stageClearTitle">CLEAR</span>
            <div class="story-rewards">
              <span class="story-reward coin">+<span id="stageRewardCoin">0</span>ü™ô</span>
              <span class="story-reward gem" id="stageRewardGemWrap">+<span id="stageRewardGem">0</span>üíé</span>
            </div>
          </div>
          <div class="story-text-box">
            <div class="story-text" id="storyText"></div>
          </div>
          <button class="stage-clear-btn" id="nextStageBtn">‚ñ∂ NEXT</button>
        </div>
      </div>
    </div>

    <!-- Gem Popup -->
    <div class="gem-popup hidden" id="gemPopup">
      <h3>üíé GEM!</h3>
      <div class="gem-icon">üíé</div>
      <p id="gemPopupText">+1 Gem</p>
      <button class="btn btn-gem" onclick="closeGemPopup()">OK</button>
    </div>

    <div id="toast"></div>
  </div>

<script>
var SUPABASE_URL = 'https://ealukkcyetnoouslojaa.supabase.co';
var CFG = { STAGES: 7, BASE_CD: 10000, PADDLE_SPD: 2.5, DROP_RATE: 0.2, GEM_DROP: 0.03, GEM_VIDEO_COST: 3 };

var STG = {
  1:{r:3,c:5,s:2.5,hp:1,boss:false},2:{r:3,c:6,s:2.7,hp:2,boss:false},3:{r:4,c:6,s:2.9,hp:2,boss:false},
  4:{r:4,c:6,s:3.1,hp:3,boss:false},5:{r:4,c:7,s:3.3,hp:3,boss:false},6:{r:5,c:7,s:3.5,hp:4,boss:false},
  7:{r:5,c:7,s:3.7,hp:5,boss:true}
};

var WEAPONS = [
  {id:'w1',name:'Cannon',icon:'üî´',desc:'Basic',baseDmg:1,maxLv:10,basePrice:100,priceUp:50},
  {id:'w2',name:'Double',icon:'üí®',desc:'2 shots',baseDmg:1,maxLv:10,basePrice:200,priceUp:100,unlockReq:'w1'},
  {id:'w3',name:'Laser',icon:'‚ö°',desc:'Pierce',baseDmg:2,maxLv:10,basePrice:400,priceUp:150,unlockReq:'w2'},
  {id:'w4',name:'Missile',icon:'üöÄ',desc:'Homing',baseDmg:3,maxLv:10,basePrice:800,priceUp:200,unlockReq:'w3'}
];
var SKILLS = [
  {id:'s1',name:'Pierce',icon:'üî•',desc:'Ball pierce',maxLv:5,basePrice:300,priceUp:150,duration:3000,durationUp:500},
  {id:'s2',name:'Lightning',icon:'‚ö°',desc:'Random hit',maxLv:5,basePrice:500,priceUp:200,hits:2,hitsUp:1,unlockReq:'s1'},
  {id:'s3',name:'Bomb',icon:'üí•',desc:'AOE',maxLv:5,basePrice:800,priceUp:250,radius:60,radiusUp:15,unlockReq:'s2'},
  {id:'s4',name:'Boost',icon:'‚è±Ô∏è',desc:'CD reset',maxLv:5,basePrice:1000,priceUp:300,unlockReq:'s3'}
];
var PADDLE_UPGRADES = [
  {id:'p_width',name:'Width',icon:'üìè',desc:'+Size',maxLv:10,basePrice:150,priceUp:75},
  {id:'p_magnet',name:'Magnet',icon:'üß≤',desc:'Pull items',maxLv:5,basePrice:400,priceUp:200},
  {id:'p_catch',name:'Catch',icon:'üñêÔ∏è',desc:'Hold ball',maxLv:5,basePrice:500,priceUp:250},
  {id:'p_speed',name:'Speed',icon:'üëü',desc:'+Speed',maxLv:10,basePrice:100,priceUp:50},
  {id:'p_multi',name:'Multi',icon:'‚ö™',desc:'+Balls',maxLv:3,basePrice:1000,priceUp:500}
];
var BALL_UPGRADES = [
  {id:'b_dmg',name:'Damage',icon:'üí™',desc:'+DMG',maxLv:10,basePrice:200,priceUp:100},
  {id:'b_speed',name:'Speed',icon:'üí®',desc:'+Speed',maxLv:5,basePrice:300,priceUp:150},
  {id:'b_size',name:'Size',icon:'üîµ',desc:'+Size',maxLv:5,basePrice:250,priceUp:125}
];

var CHARACTERS = [{id:1,name:'Mystery',unlocked:true},{id:2,name:'Sunset',unlocked:false},{id:3,name:'Midnight',unlocked:false},{id:4,name:'Cherry',unlocked:false},{id:5,name:'Golden',unlocked:false},{id:6,name:'Silver',unlocked:false}];

var gameData = {
  rounds: [{id:1,name:'Chapter 1',mapBg:'',stages:[
    {id:1,text:'',hasVideo:false,x:15,y:85},{id:2,text:'',hasVideo:false,x:30,y:70},{id:3,text:'',hasVideo:false,x:50,y:60},
    {id:4,text:'',hasVideo:false,x:65,y:45},{id:5,text:'',hasVideo:false,x:50,y:30},{id:6,text:'',hasVideo:false,x:70,y:20},{id:7,text:'',hasVideo:false,x:85,y:10}
  ]}]
};

var clearedStages = {}, watchedVideos = {};
var canvas, ctx, state = 'menu';
var coins = 0, gems = 0, score = 0, lives = 3, maxLives = 3;
var round = 1, stage = 1, earned = 0, earnedGem = 0, selectedMapRound = 1;
var currentTab = 'weapon', returnTo = 'menu', upgrades = {};
var paddle, balls, bullets, bricks, items, fx, particles;
var input = {left:false, right:false, fire:false};
var lastFire = 0, skillCD = [0,0,0,0], catching = false;
var typingInterval = null, currentGalleryKey = '';

window.onload = function(){
  loadData();
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);
  setupInput();
  setupButtons();
  updateUI();
  updateSkillButtons();
  requestAnimationFrame(loop);
};

function loadData(){
  coins = parseInt(localStorage.getItem('nb_coins')) || 0;
  gems = parseInt(localStorage.getItem('nb_gems')) || 0;
  round = parseInt(localStorage.getItem('nb_round')) || 1;
  stage = parseInt(localStorage.getItem('nb_stage')) || 1;
  upgrades = JSON.parse(localStorage.getItem('nb_upgrades')) || {};
  clearedStages = JSON.parse(localStorage.getItem('nb_cleared')) || {};
  watchedVideos = JSON.parse(localStorage.getItem('nb_watched')) || {};
  var chars = localStorage.getItem('nb_characters');
  if(chars) CHARACTERS = JSON.parse(chars);
  var gd = localStorage.getItem('nb_gamedata');
  if(gd) gameData = JSON.parse(gd);
}

function saveData(){
  localStorage.setItem('nb_coins', coins);
  localStorage.setItem('nb_gems', gems);
  localStorage.setItem('nb_round', round);
  localStorage.setItem('nb_stage', stage);
  localStorage.setItem('nb_upgrades', JSON.stringify(upgrades));
  localStorage.setItem('nb_characters', JSON.stringify(CHARACTERS));
  localStorage.setItem('nb_cleared', JSON.stringify(clearedStages));
  localStorage.setItem('nb_watched', JSON.stringify(watchedVideos));
}

function resize(){
  var area = document.getElementById('gameArea');
  canvas.width = area.clientWidth;
  canvas.height = area.clientHeight;
}

function getLv(id){ return upgrades[id] || 0; }
function setLv(id, lv){ upgrades[id] = lv; saveData(); }
function isUnlocked(item){ return !item.unlockReq || getLv(item.unlockReq) >= 5; }
function getPrice(item){ return item.basePrice + (getLv(item.id) * item.priceUp); }
function canBuy(item){ return getLv(item.id) < item.maxLv && isUnlocked(item) && coins >= getPrice(item); }

function updateUI(){
  ['menuCoins','shopCoins','hudCoins'].forEach(function(id){ var e=document.getElementById(id); if(e) e.textContent = coins.toLocaleString(); });
  ['menuGems','hudGems','galleryGems'].forEach(function(id){ var e=document.getElementById(id); if(e) e.textContent = gems; });
}

function updateHUD(){
  document.getElementById('hudScore').textContent = score.toLocaleString();
  document.getElementById('hudRound').textContent = round + '-' + stage;
  var h = '';
  for(var i = 0; i < maxLives; i++) h += '<div class="heart ' + (i < lives ? '' : 'empty') + '"></div>';
  document.getElementById('livesBar').innerHTML = h;
}

function updateSkillButtons(){
  for(var i = 1; i <= 4; i++){
    var lv = getLv(SKILLS[i-1].id);
    document.getElementById('skill' + i + 'Lvl').textContent = lv > 0 ? 'Lv.' + lv : '-';
    document.getElementById('skill' + i).classList.toggle('unlocked', lv > 0);
  }
}

function toast(msg){
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2000);
}

function showGemPopup(amount){
  document.getElementById('gemPopupText').textContent = '+' + amount + ' Gem';
  document.getElementById('gemPopup').classList.remove('hidden');
}
function closeGemPopup(){ document.getElementById('gemPopup').classList.add('hidden'); }

function watchAd(){
  toast('Loading...');
  setTimeout(function(){ gems += 3; saveData(); updateUI(); showGemPopup(3); }, 1500);
}

function typeText(text, element){
  if(typingInterval) clearInterval(typingInterval);
  element.innerHTML = '';
  if(!text){ element.innerHTML = '...'; return; }
  var i = 0;
  function type(){
    if(i < text.length){ element.innerHTML = text.substring(0, i+1) + '<span class="story-cursor"></span>'; i++; }
    else { clearInterval(typingInterval); element.innerHTML = text; }
  }
  typingInterval = setInterval(type, 25);
}

// Stage Map
function getMaxClearedStage(r){
  var rd = gameData.rounds.find(function(x){ return x.id === r; });
  if(!rd) return 0;
  var max = 0;
  rd.stages.forEach(function(st){
    if(clearedStages['r' + r + '_s' + st.id]) max = Math.max(max, st.id);
  });
  return max;
}

function isRoundUnlocked(r){
  if(r === 1) return true;
  var prevRd = gameData.rounds.find(function(x){ return x.id === r - 1; });
  if(!prevRd) return false;
  var lastStage = prevRd.stages[prevRd.stages.length - 1];
  return clearedStages['r' + (r-1) + '_s' + lastStage.id];
}

function renderStageMap(){
  var rd = gameData.rounds.find(function(x){ return x.id === selectedMapRound; });
  if(!rd) return;
  
  // Round selector
  var selHtml = '';
  gameData.rounds.forEach(function(r){
    var unlocked = isRoundUnlocked(r.id);
    selHtml += '<button class="round-btn ' + (r.id === selectedMapRound ? 'active' : '') + (unlocked ? '' : ' locked') + '" data-round="' + r.id + '">' + r.name + '</button>';
  });
  document.getElementById('roundSelector').innerHTML = selHtml;
  document.querySelectorAll('.round-btn').forEach(function(btn){
    btn.onclick = function(){
      if(btn.classList.contains('locked')) return;
      selectedMapRound = parseInt(btn.dataset.round);
      renderStageMap();
    };
  });
  
  // Map background
  var bg = document.getElementById('stageMapBg');
  if(rd.mapBg){
    var url = SUPABASE_URL + '/storage/v1/object/public/secret/map_r' + rd.id + '.jpg';
    bg.innerHTML = '<img src="' + url + '" onerror="this.src=\'' + url.replace('.jpg','.png') + '\'">';
  } else {
    bg.innerHTML = '';
    bg.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
  }
  
  // Nodes
  var maxCleared = getMaxClearedStage(selectedMapRound);
  var nodesHtml = '';
  
  rd.stages.forEach(function(st, idx){
    var key = 'r' + rd.id + '_s' + st.id;
    var isCleared = clearedStages[key];
    var isCurrent = !isCleared && (st.id === 1 || clearedStages['r' + rd.id + '_s' + (st.id - 1)]);
    var isLocked = !isCleared && !isCurrent;
    var isBoss = st.id === rd.stages.length;
    
    var cls = 'stage-node';
    if(isLocked) cls += ' locked';
    else if(isCleared) cls += ' cleared';
    else if(isCurrent) cls += ' current';
    if(isBoss) cls += ' boss';
    
    nodesHtml += '<div class="' + cls + '" data-round="' + rd.id + '" data-stage="' + st.id + '" style="left:' + st.x + '%;top:' + st.y + '%;">' + st.id + '</div>';
  });
  
  document.getElementById('stageNodes').innerHTML = nodesHtml;
  
  // Click handlers
  document.querySelectorAll('.stage-node').forEach(function(node){
    node.onclick = function(){
      if(node.classList.contains('locked')) return;
      round = parseInt(node.dataset.round);
      stage = parseInt(node.dataset.stage);
      saveData();
      startGame();
    };
  });
}

function showStageMap(){
  hideAll();
  selectedMapRound = round;
  renderStageMap();
  document.getElementById('stageMapScreen').classList.remove('hidden');
}

// Shop
function renderShop(){
  var list = document.getElementById('shopList');
  var items = currentTab === 'weapon' ? WEAPONS : currentTab === 'skill' ? SKILLS : currentTab === 'paddle' ? PADDLE_UPGRADES : BALL_UPGRADES;
  list.innerHTML = items.map(function(item){
    var lv = getLv(item.id), maxed = lv >= item.maxLv, unlocked = isUnlocked(item);
    var html = '<div class="shop-item ' + (maxed ? 'maxed' : '') + (!unlocked ? ' locked' : '') + '">';
    html += '<div class="icon-box">' + item.icon + '</div><div class="info">';
    html += '<div class="name">' + item.name + '</div><div class="desc">' + item.desc + '</div>';
    if(unlocked){ html += '<div class="level">Lv.' + lv + '/' + item.maxLv + '</div><div class="level-bar"><div class="level-fill" style="width:' + (lv/item.maxLv*100) + '%"></div></div>'; }
    html += '</div>';
    if(maxed) html += '<button class="shop-btn shop-btn-max" disabled>MAX</button>';
    else if(unlocked) html += '<button class="shop-btn shop-btn-buy" data-id="' + item.id + '" ' + (coins >= getPrice(item) ? '' : 'disabled') + '>ü™ô' + getPrice(item) + '</button>';
    return html + '</div>';
  }).join('');
  list.querySelectorAll('.shop-btn-buy').forEach(function(btn){
    btn.onclick = function(){
      var item = WEAPONS.concat(SKILLS,PADDLE_UPGRADES,BALL_UPGRADES).find(function(x){ return x.id === btn.dataset.id; });
      if(item && canBuy(item)){ coins -= getPrice(item); setLv(item.id, getLv(item.id) + 1); updateUI(); updateSkillButtons(); renderShop(); toast(item.name + ' Lv.' + getLv(item.id)); }
    };
  });
}

// Gallery
function renderGallery(){
  var scroll = document.getElementById('galleryScroll');
  var html = '';
  gameData.rounds.forEach(function(rd){
    html += '<div class="gallery-section"><div class="gallery-section-title">' + rd.name + '</div><div class="gallery-grid">';
    rd.stages.forEach(function(st){
      var key = 'r' + rd.id + '_s' + st.id;
      var isCleared = clearedStages[key];
      html += '<div class="gallery-item ' + (isCleared ? '' : 'locked') + '" data-key="' + key + '" data-round="' + rd.id + '" data-stage="' + st.id + '">';
      if(isCleared) html += '<img src="" data-key="' + key + '" class="gallery-thumb">';
      if(st.hasVideo && isCleared) html += '<div class="has-video">‚ñ∂</div>';
      html += '<div class="gallery-label">S' + st.id + '</div></div>';
    });
    html += '</div></div>';
  });
  scroll.innerHTML = html;
  scroll.querySelectorAll('.gallery-thumb').forEach(function(img){
    var key = img.dataset.key;
    var baseUrl = SUPABASE_URL + '/storage/v1/object/public/secret/' + key;
    img.src = baseUrl + '.jpg';
    img.onerror = function(){ if(this.src.endsWith('.jpg')) this.src = baseUrl + '.png'; };
  });
  scroll.querySelectorAll('.gallery-item:not(.locked)').forEach(function(item){
    item.onclick = function(){
      var key = item.dataset.key;
      currentGalleryKey = key;
      var rd = gameData.rounds.find(function(r){ return r.id == item.dataset.round; });
      var st = rd ? rd.stages.find(function(s){ return s.id == item.dataset.stage; }) : null;
      var baseUrl = SUPABASE_URL + '/storage/v1/object/public/secret/' + key;
      document.getElementById('galleryViewBg').innerHTML = '<img src="' + baseUrl + '.jpg" onerror="this.src=\'' + baseUrl + '.png\'">';
      document.getElementById('galleryViewTitle').textContent = (rd ? rd.name : '') + ' - Stage ' + item.dataset.stage;
      document.getElementById('galleryViewText').textContent = st ? st.text : '';
      var videoBtn = document.getElementById('galleryVideoBtn');
      if(st && st.hasVideo){
        videoBtn.classList.remove('hidden');
        if(watchedVideos[key]){ videoBtn.textContent = '‚ñ∂ PLAY'; videoBtn.disabled = false; videoBtn.onclick = function(){ playGalleryVideo(key); }; }
        else { videoBtn.textContent = 'üíé ' + CFG.GEM_VIDEO_COST + ' VIDEO'; videoBtn.disabled = gems < CFG.GEM_VIDEO_COST; videoBtn.onclick = function(){ unlockVideo(key); }; }
      } else { videoBtn.classList.add('hidden'); }
      document.getElementById('galleryView').classList.remove('hidden');
    };
  });
}

function unlockVideo(key){
  if(gems < CFG.GEM_VIDEO_COST){ toast('Not enough gems!'); return; }
  gems -= CFG.GEM_VIDEO_COST; watchedVideos[key] = true; saveData(); updateUI(); playGalleryVideo(key);
}
function playGalleryVideo(key){
  var baseUrl = SUPABASE_URL + '/storage/v1/object/public/secret/' + key;
  document.getElementById('galleryViewBg').innerHTML = '<video src="' + baseUrl + '_vid.mp4" controls autoplay style="max-width:100%;max-height:100%;border-radius:10px;"></video>';
  var btn = document.getElementById('galleryVideoBtn'); btn.textContent = '‚ñ∂ PLAY'; btn.onclick = function(){ playGalleryVideo(key); };
}

// Game Logic
function getRoundData(){ return gameData.rounds.find(function(r){ return r.id === round; }) || gameData.rounds[0]; }
function getStageData(){ var rd = getRoundData(); return rd.stages.find(function(s){ return s.id === stage; }) || rd.stages[0]; }
function getMaxStages(){ var rd = getRoundData(); return rd ? rd.stages.length : 7; }

function getStageCfg(){
  var cfg = STG[Math.min(stage, 7)] || STG[7];
  var bonus = (round - 1) * 0.2;
  return { r: Math.min(8, cfg.r + Math.floor(bonus)), c: Math.min(9, cfg.c), s: cfg.s + bonus * 0.3, hp: cfg.hp + Math.floor(bonus * 2), boss: stage === getMaxStages() };
}

function initGame(){
  var pWidth = canvas.width * 0.12 * (1 + getLv('p_width') * 0.05);
  paddle = { w: pWidth, h: 14, x: canvas.width/2 - pWidth/2, y: canvas.height - 25, speed: CFG.PADDLE_SPD + getLv('p_speed') * 0.3 };
  balls = []; for(var i = 0; i < 1 + getLv('p_multi'); i++) balls.push(makeBall());
  bullets = []; items = []; fx = []; particles = []; catching = false;
  makeBricks();
}

function makeBall(x, y, dx, dy){
  var spd = getStageCfg().s + getLv('b_speed') * 0.3;
  return { x: x !== undefined ? x : canvas.width/2, y: y !== undefined ? y : paddle.y - 10, r: 6 + getLv('b_size'), dx: dx !== undefined ? dx : 0, dy: dy !== undefined ? dy : 0, speed: spd, attached: dx === undefined, piercing: false, pierceTime: 0, dmg: 1 + getLv('b_dmg') };
}

function makeBricks(){
  bricks = [];
  var cfg = getStageCfg(), pad = 8, bw = (canvas.width - pad*2) / cfg.c - 3, bh = 22;
  for(var r = 0; r < cfg.r; r++){
    for(var c = 0; c < cfg.c; c++){
      var hp = cfg.hp + Math.floor(Math.random() * 2);
      var isBoss = cfg.boss && r === 0;
      if(isBoss) hp *= 3;
      bricks.push({ x: pad + c * (bw + 3), y: 50 + r * (bh + 3), w: bw, h: bh, hp: hp, maxHp: hp, hue: (r * 40 + c * 20 + stage * 30) % 360, boss: isBoss });
    }
  }
}

function update(){
  if(state !== 'playing') return;
  if(input.left) paddle.x = Math.max(0, paddle.x - paddle.speed);
  if(input.right) paddle.x = Math.min(canvas.width - paddle.w, paddle.x + paddle.speed);
  if(input.fire){
    if(catching){ catching = false; balls.forEach(function(b){ if(b.attached){ b.attached = false; b.dx = (Math.random()-0.5)*4; b.dy = -b.speed; }}); }
    else { balls.forEach(function(b){ if(b.attached){ b.attached = false; b.dx = (Math.random()-0.5)*3; b.dy = -b.speed; }}); fireWeapon(); }
  }
  updateBalls(); updateBullets(); updateItems(); updateFx(); updateSkillCD(); updateHUD();
  if(bricks.length === 0) stageClear();
  if(balls.length === 0){ lives--; if(lives <= 0) gameOver(); else balls.push(makeBall()); }
}

function updateBalls(){
  var catchLv = getLv('p_catch');
  for(var i = balls.length - 1; i >= 0; i--){
    var b = balls[i];
    if(b.attached){ b.x = paddle.x + paddle.w/2; b.y = paddle.y - b.r; continue; }
    if(b.piercing){ b.pierceTime -= 16; if(b.pierceTime <= 0) b.piercing = false; }
    b.x += b.dx; b.y += b.dy;
    if(b.x <= b.r){ b.x = b.r; b.dx = Math.abs(b.dx); }
    if(b.x >= canvas.width - b.r){ b.x = canvas.width - b.r; b.dx = -Math.abs(b.dx); }
    if(b.y <= b.r){ b.y = b.r; b.dy = Math.abs(b.dy); }
    if(b.dy > 0 && b.y + b.r >= paddle.y && b.y - b.r <= paddle.y + paddle.h && b.x >= paddle.x - b.r && b.x <= paddle.x + paddle.w + b.r){
      if(catchLv > 0 && !catching){ catching = true; b.attached = true; b.dx = 0; b.dy = 0; }
      else { b.y = paddle.y - b.r; b.dy = -Math.abs(b.dy); b.dx = ((b.x - paddle.x) / paddle.w - 0.5) * b.speed * 1.5; }
    }
    for(var j = bricks.length - 1; j >= 0; j--){
      var br = bricks[j];
      if(b.x + b.r > br.x && b.x - b.r < br.x + br.w && b.y + b.r > br.y && b.y - b.r < br.y + br.h){
        hitBrick(br, j, b.dmg);
        if(!b.piercing){ var ox = Math.min(b.x + b.r - br.x, br.x + br.w - (b.x - b.r)), oy = Math.min(b.y + b.r - br.y, br.y + br.h - (b.y - b.r)); if(ox < oy) b.dx *= -1; else b.dy *= -1; }
        break;
      }
    }
    if(b.y > canvas.height + 20) balls.splice(i, 1);
  }
}

function fireWeapon(){
  var now = Date.now(); if(now - lastFire < 400) return; lastFire = now;
  var dmg = Math.max(1, getLv('w1'), getLv('w2'), getLv('w3'), getLv('w4'));
  var cx = paddle.x + paddle.w/2, cy = paddle.y;
  if(getLv('w4') > 0) bullets.push({x:cx,y:cy,dx:0,dy:-8,dmg:dmg*3,type:'missile',homing:true});
  else if(getLv('w3') > 0) bullets.push({x:cx,y:cy,dx:0,dy:-12,dmg:dmg*2,type:'laser',pierce:true,w:6,h:20});
  else if(getLv('w2') > 0){ bullets.push({x:cx-10,y:cy,dx:-1,dy:-10,dmg:dmg,type:'normal'}); bullets.push({x:cx+10,y:cy,dx:1,dy:-10,dmg:dmg,type:'normal'}); }
  else if(getLv('w1') > 0) bullets.push({x:cx,y:cy,dx:0,dy:-10,dmg:dmg,type:'normal'});
}

function updateBullets(){
  for(var i = bullets.length - 1; i >= 0; i--){
    var b = bullets[i];
    if(b.homing && bricks.length > 0){ var t = bricks[0], a = Math.atan2(t.y + t.h/2 - b.y, t.x + t.w/2 - b.x); b.dx += Math.cos(a)*0.5; b.dy += Math.sin(a)*0.5; var s = Math.sqrt(b.dx*b.dx+b.dy*b.dy); if(s > 10){ b.dx = b.dx/s*10; b.dy = b.dy/s*10; }}
    b.x += b.dx; b.y += b.dy;
    if(b.y < -20 || b.y > canvas.height || b.x < 0 || b.x > canvas.width){ bullets.splice(i, 1); continue; }
    for(var j = bricks.length - 1; j >= 0; j--){
      var br = bricks[j], bw = b.w || 8, bh = b.h || 8;
      if(b.x + bw/2 > br.x && b.x - bw/2 < br.x + br.w && b.y + bh/2 > br.y && b.y - bh/2 < br.y + br.h){
        hitBrick(br, j, b.dmg); if(!b.pierce) bullets.splice(i, 1); break;
      }
    }
  }
}

function hitBrick(br, idx, dmg){
  br.hp -= dmg;
  for(var i = 0; i < 4; i++) particles.push({ x: br.x + br.w/2, y: br.y + br.h/2, dx: (Math.random()-0.5)*5, dy: (Math.random()-0.5)*5, life: 15, hue: br.hue });
  if(br.hp <= 0) destroyBrick(br, idx);
}

function destroyBrick(br, idx){
  var r = 5 + round + stage; coins += r; earned += r; score += 10;
  if(br.boss){ gems++; earnedGem++; saveData(); }
  else if(Math.random() < CFG.GEM_DROP){ gems++; earnedGem++; spawnItem(br.x + br.w/2, br.y + br.h/2, 'gem'); saveData(); }
  else if(Math.random() < CFG.DROP_RATE) spawnItem(br.x + br.w/2, br.y + br.h/2);
  bricks.splice(idx, 1); updateUI();
}

function spawnItem(x, y, type){
  var types = [{t:'life',icon:'‚ô•',color:'#f55'},{t:'coin',icon:'ü™ô',color:'#fd0'},{t:'power',icon:'‚¨Ü',color:'#0ff'}];
  if(type === 'gem') items.push({x:x, y:y, dy:2, type:'gem', icon:'üíé', color:'#a855f7'});
  else { var item = types[Math.floor(Math.random() * types.length)]; items.push({x:x, y:y, dy:2, type:item.t, icon:item.icon, color:item.color}); }
}

function updateItems(){
  var mag = getLv('p_magnet') * 20;
  for(var i = items.length - 1; i >= 0; i--){
    var it = items[i]; it.y += it.dy;
    if(mag > 0){ var dx = paddle.x + paddle.w/2 - it.x, dy = paddle.y - it.y, dist = Math.sqrt(dx*dx+dy*dy); if(dist < mag){ it.x += dx*0.1; it.y += dy*0.1; }}
    if(it.y + 10 >= paddle.y && it.y - 10 <= paddle.y + paddle.h && it.x >= paddle.x - 10 && it.x <= paddle.x + paddle.w + 10){ collectItem(it); items.splice(i, 1); continue; }
    if(it.y > canvas.height + 20) items.splice(i, 1);
  }
}

function collectItem(it){
  if(it.type === 'life'){ lives = Math.min(lives + 1, maxLives); toast('+1 LIFE'); }
  else if(it.type === 'coin'){ coins += 20; earned += 20; toast('+20'); }
  else if(it.type === 'power'){ balls.forEach(function(b){ b.dmg += 1; }); toast('POWER!'); }
  else if(it.type === 'gem'){ toast('+1üíé'); }
  updateUI();
}

function updateFx(){
  for(var i = fx.length - 1; i >= 0; i--){ fx[i].r += 8; if(fx[i].r >= fx[i].max) fx.splice(i, 1); }
  for(var i = particles.length - 1; i >= 0; i--){ var p = particles[i]; p.x += p.dx; p.y += p.dy; p.dy += 0.2; p.life--; if(p.life <= 0) particles.splice(i, 1); }
}

function useSkill(n){
  if(state !== 'playing') return;
  var sk = SKILLS[n-1], lv = getLv(sk.id); if(lv <= 0) return;
  var now = Date.now(), cd = CFG.BASE_CD * (1 - getLv('s4') * 0.1);
  if(now - skillCD[n-1] < cd) return;
  skillCD[n-1] = now;
  if(n === 1){ var dur = sk.duration + lv * sk.durationUp; balls.forEach(function(b){ b.piercing = true; b.pierceTime = dur; }); toast('PIERCE!'); }
  else if(n === 2){ var hits = sk.hits + lv * sk.hitsUp; for(var i = 0; i < hits && bricks.length > 0; i++){ var idx = Math.floor(Math.random() * bricks.length); hitBrick(bricks[idx], idx, 999); } toast('LIGHTNING!'); }
  else if(n === 3){ var rad = sk.radius + lv * sk.radiusUp, cx = canvas.width/2, cy = canvas.height/3; fx.push({x:cx,y:cy,r:0,max:rad}); for(var i = bricks.length - 1; i >= 0; i--){ var br = bricks[i]; if(Math.hypot(br.x + br.w/2 - cx, br.y + br.h/2 - cy) < rad) hitBrick(br, i, 999); } toast('BOMB!'); }
  else if(n === 4){ skillCD = [0,0,0,0]; toast('RESET!'); }
}

function updateSkillCD(){
  var now = Date.now(), cd = CFG.BASE_CD * (1 - getLv('s4') * 0.1);
  for(var i = 0; i < 4; i++){ var el = document.getElementById('cd' + (i+1)), elapsed = now - skillCD[i]; el.style.height = elapsed < cd ? ((cd - elapsed)/cd * 100) + '%' : '0%'; }
}

function render(){
  ctx.fillStyle = '#030308'; ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.strokeStyle = 'rgba(0,240,255,0.03)';
  for(var x = 0; x < canvas.width; x += 40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
  for(var y = 0; y < canvas.height; y += 40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
  if(state !== 'playing' && state !== 'paused') return;
  
  fx.forEach(function(e){ var g = ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r); g.addColorStop(0,'rgba(255,100,0,0.6)'); g.addColorStop(1,'rgba(255,0,0,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill(); });
  
  bricks.forEach(function(br){
    var pct = br.hp / br.maxHp;
    if(br.boss){ ctx.fillStyle = 'hsl(280,80%,'+(30+pct*30)+'%)'; ctx.shadowBlur = 15; ctx.shadowColor = '#a855f7'; }
    else { ctx.fillStyle = 'hsl('+br.hue+',60%,'+(30+pct*30)+'%)'; ctx.shadowBlur = 0; }
    ctx.fillRect(br.x, br.y, br.w, br.h);
    ctx.shadowBlur = 0;
    ctx.fillStyle = '#fff'; ctx.font = 'bold 10px Orbitron'; ctx.textAlign = 'center'; ctx.fillText(br.hp, br.x + br.w/2, br.y + br.h/2 + 4);
  });
  
  items.forEach(function(it){ ctx.fillStyle = it.color; if(it.type === 'gem'){ ctx.shadowBlur = 15; ctx.shadowColor = '#a855f7'; } ctx.beginPath(); ctx.arc(it.x, it.y, 12, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; ctx.fillStyle = '#000'; ctx.font = '12px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(it.icon, it.x, it.y); });
  
  bullets.forEach(function(b){ ctx.fillStyle = b.type === 'laser' ? '#f0f' : b.type === 'missile' ? '#f60' : '#0ff'; if(b.w) ctx.fillRect(b.x - b.w/2, b.y - b.h/2, b.w, b.h); else { ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); }});
  
  balls.forEach(function(b){ ctx.fillStyle = b.piercing ? '#f80' : '#fff'; ctx.shadowBlur = 20; ctx.shadowColor = b.piercing ? '#f80' : '#0ff'; ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; });
  
  ctx.fillStyle = '#0ff'; ctx.shadowBlur = 25; ctx.shadowColor = '#0ff'; ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h); ctx.shadowBlur = 0;
  
  particles.forEach(function(p){ ctx.globalAlpha = p.life / 15; ctx.fillStyle = 'hsl('+p.hue+',70%,60%)'; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); });
  ctx.globalAlpha = 1;
}

function loop(){ update(); render(); requestAnimationFrame(loop); }

function hideAll(){ ['startScreen','stageMapScreen','shopScreen','galleryScreen','pauseScreen','gameOverScreen','stageClearScreen'].forEach(function(id){ document.getElementById(id).classList.add('hidden'); }); document.getElementById('galleryView').classList.add('hidden'); }

function showStart(){ hideAll(); updateUI(); document.getElementById('startScreen').classList.remove('hidden'); state = 'menu'; }

function startGame(){
  var elem = document.documentElement;
  if(elem.requestFullscreen) elem.requestFullscreen();
  else if(elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
  hideAll(); state = 'playing'; score = 0; lives = maxLives; earned = 0; earnedGem = 0; skillCD = [0,0,0,0]; initGame();
}

function stageClear(){
  state = 'stageclear';
  var coinReward = 50 + stage * 20; coins += coinReward; earned += coinReward;
  var gemReward = getStageCfg().boss ? 2 : 0;
  if(gemReward > 0){ gems += gemReward; earnedGem += gemReward; }
  
  var currentStage = stage, currentRound = round;
  var key = 'r' + currentRound + '_s' + currentStage;
  clearedStages[key] = true;
  
  var stageData = getStageData(), roundData = getRoundData();
  document.getElementById('stageClearTitle').textContent = roundData.name + ' // S' + stage;
  document.getElementById('stageRewardCoin').textContent = coinReward;
  document.getElementById('stageRewardGem').textContent = gemReward;
  document.getElementById('stageRewardGemWrap').style.display = gemReward > 0 ? 'inline' : 'none';
  
  typeText(stageData.text || '...', document.getElementById('storyText'));
  loadStageMedia(currentRound, currentStage);
  
  // 3Ï¥à ÌõÑ Î≤ÑÌäº ÌëúÏãú
  var btn = document.getElementById('nextStageBtn');
  btn.classList.remove('visible');
  setTimeout(function(){ btn.classList.add('visible'); }, 3000);
  
  if(stage >= getMaxStages()){ round++; stage = 1; if(round <= CHARACTERS.length) CHARACTERS[round-1].unlocked = true; }
  else stage++;
  
  saveData(); updateUI();
  document.getElementById('stageClearScreen').classList.remove('hidden');
}

function loadStageMedia(r, s){
  var bg = document.getElementById('stageClearBg');
  var base = SUPABASE_URL + '/storage/v1/object/public/secret/r' + r + '_s' + s;
  var img = new Image();
  img.onload = function(){ bg.innerHTML = '<img src="' + base + '.jpg">'; };
  img.onerror = function(){
    var img2 = new Image();
    img2.onload = function(){ bg.innerHTML = '<img src="' + base + '.png">'; };
    img2.onerror = function(){ bg.innerHTML = ''; };
    img2.src = base + '.png';
  };
  img.src = base + '.jpg';
}

function nextStage(){ hideAll(); initGame(); state = 'playing'; }

function gameOver(){ state = 'gameover'; document.getElementById('earnedCoins').textContent = earned; document.getElementById('earnedGems').textContent = earnedGem; document.getElementById('finalScore').textContent = score; saveData(); document.getElementById('gameOverScreen').classList.remove('hidden'); }

function showShop(from){ returnTo = from || 'menu'; hideAll(); updateUI(); renderShop(); document.getElementById('shopScreen').classList.remove('hidden'); }
function closeShop(){ hideAll(); if(returnTo === 'pause') document.getElementById('pauseScreen').classList.remove('hidden'); else showStart(); }

function showGallery(){ hideAll(); updateUI(); renderGallery(); document.getElementById('galleryScreen').classList.remove('hidden'); }

function setupInput(){
  var L = document.getElementById('leftBtn'), R = document.getElementById('rightBtn'), F = document.getElementById('fireBtn');
  L.ontouchstart = function(e){ e.preventDefault(); input.left = true; };
  L.ontouchend = function(e){ e.preventDefault(); input.left = false; };
  R.ontouchstart = function(e){ e.preventDefault(); input.right = true; };
  R.ontouchend = function(e){ e.preventDefault(); input.right = false; };
  F.ontouchstart = function(e){ e.preventDefault(); input.fire = true; };
  F.ontouchend = function(e){ e.preventDefault(); input.fire = false; };
  L.onmousedown = function(){ input.left = true; }; L.onmouseup = L.onmouseleave = function(){ input.left = false; };
  R.onmousedown = function(){ input.right = true; }; R.onmouseup = R.onmouseleave = function(){ input.right = false; };
  F.onmousedown = function(){ input.fire = true; }; F.onmouseup = F.onmouseleave = function(){ input.fire = false; };
  document.onkeydown = function(e){ if(e.key === 'ArrowLeft') input.left = true; if(e.key === 'ArrowRight') input.right = true; if(e.key === ' ' || e.key === 'z'){ input.fire = true; e.preventDefault(); } if(e.key >= '1' && e.key <= '4') useSkill(parseInt(e.key)); };
  document.onkeyup = function(e){ if(e.key === 'ArrowLeft') input.left = false; if(e.key === 'ArrowRight') input.right = false; if(e.key === ' ' || e.key === 'z') input.fire = false; };
  for(var i = 1; i <= 4; i++)(function(n){ document.getElementById('skill' + n).onclick = function(){ useSkill(n); }; })(i);
}

function setupButtons(){
  document.getElementById('startBtn').onclick = showStageMap;
  document.getElementById('shopBtn').onclick = function(){ showShop('menu'); };
  document.getElementById('galleryBtn').onclick = showGallery;
  document.getElementById('adBtn').onclick = watchAd;
  document.getElementById('mapBackBtn').onclick = showStart;
  document.getElementById('closeShopBtn').onclick = closeShop;
  document.getElementById('closeGalleryBtn').onclick = showStart;
  document.getElementById('galleryCloseBtn').onclick = function(){ document.getElementById('galleryView').classList.add('hidden'); };
  document.querySelectorAll('.shop-tab').forEach(function(tab){ tab.onclick = function(){ document.querySelectorAll('.shop-tab').forEach(function(t){ t.classList.remove('active'); }); tab.classList.add('active'); currentTab = tab.dataset.tab; renderShop(); }; });
  document.getElementById('pauseBtn').onclick = function(){ if(state === 'playing'){ state = 'paused'; document.getElementById('pauseScreen').classList.remove('hidden'); }};
  document.getElementById('resumeBtn').onclick = function(){ hideAll(); state = 'playing'; };
  document.getElementById('pauseShopBtn').onclick = function(){ showShop('pause'); };
  document.getElementById('restartBtn').onclick = function(){ hideAll(); startGame(); };
  document.getElementById('menuBtn').onclick = showStart;
  document.getElementById('retryBtn').onclick = function(){ hideAll(); startGame(); };
  document.getElementById('gameOverMenuBtn').onclick = showStart;
  document.getElementById('nextStageBtn').onclick = nextStage;
}
</script>
</body>
</html>
