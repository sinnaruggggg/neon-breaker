<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ë„¤ì˜¨ ë¸Œë ˆì´ì»¤</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{--primary:#00f0ff;--secondary:#ff00aa;--accent:#ffdd00;--success:#00ff88;--bg:#0a0a12;--card:#12121f;--text:#fff;--text-dim:#7788aa}
    *{margin:0;padding:0;box-sizing:border-box;user-select:none}
    html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);touch-action:none}
    #app{width:100%;height:100%;display:flex;flex-direction:column;background:linear-gradient(180deg,#08080f 0%,#0f0f1a 50%,#08080f 100%)}
    #header{height:50px;padding:0 12px;background:linear-gradient(180deg,rgba(0,0,0,0.9),transparent);display:flex;align-items:center;justify-content:space-between}
    .hud-group{display:flex;align-items:center;gap:12px}
    .hud-stat{display:flex;flex-direction:column;align-items:center}
    .hud-stat .label{font-size:8px;color:var(--text-dim)}
    .hud-stat .value{font-family:'Orbitron';font-size:14px;font-weight:700;color:var(--primary)}
    .hud-stat .value.gold{color:var(--accent)}
    .lives-bar{display:flex;gap:3px}
    .heart{width:12px;height:11px;background:linear-gradient(135deg,#ff5577,#ff2255);clip-path:polygon(50% 0%,100% 35%,80% 100%,50% 75%,20% 100%,0% 35%)}
    .heart.empty{background:#333}
    #pauseBtn{width:40px;height:40px;background:rgba(255,255,255,0.05);border:2px solid rgba(255,255,255,0.15);border-radius:10px;color:#fff;font-size:14px;display:flex;align-items:center;justify-content:center}
    #gameArea{flex:1;position:relative;overflow:hidden}
    #gameCanvas{width:100%;height:100%;display:block}
    #comboPopup,#stagePopup{position:absolute;left:50%;transform:translateX(-50%);font-family:'Orbitron';pointer-events:none;opacity:0;transition:all 0.3s}
    #comboPopup{top:30%;font-size:24px;font-weight:900;color:var(--accent)}
    #stagePopup{top:45%;font-size:18px;color:var(--primary)}
    #controls{height:160px;padding:8px 10px;background:linear-gradient(180deg,rgba(15,15,25,0.98),var(--bg));border-top:1px solid rgba(0,240,255,0.15)}
    #skillBar{display:flex;justify-content:center;gap:10px;margin-bottom:8px}
    .skill-btn{width:48px;height:48px;background:var(--card);border:2px solid #333;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;opacity:0.4}
    .skill-btn.unlocked{opacity:1;border-color:var(--secondary)}
    .skill-btn .icon{font-size:20px}
    .skill-btn .lvl{font-family:'Orbitron';font-size:8px;color:var(--accent)}
    .skill-btn .cd-fill{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.75);height:0%}
    #moveBar{display:flex;justify-content:space-between;align-items:center;padding:0 5px}
    .dir-btn{width:64px;height:64px;background:var(--card);border:2px solid var(--primary);border-radius:50%;color:var(--primary);font-size:24px;display:flex;align-items:center;justify-content:center}
    #fireBtn{width:75px;height:75px;background:linear-gradient(145deg,#ff0066,#bb0044);border:3px solid #ff4488;border-radius:50%;font-family:'Orbitron';font-size:11px;font-weight:900;color:#fff}
    .overlay{position:absolute;inset:0;background:rgba(5,5,12,0.97);display:flex;flex-direction:column;align-items:center;padding:15px;overflow-y:auto;z-index:100}
    .overlay.hidden{display:none}
    .overlay-inner{width:100%;max-width:360px;display:flex;flex-direction:column;align-items:center}
    .brand{margin:20px 0 12px;text-align:center}
    .brand h1{font-family:'Orbitron';font-size:28px;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .brand p{font-size:10px;color:var(--text-dim);letter-spacing:5px}
    .coin-badge{display:inline-flex;align-items:center;gap:8px;padding:8px 20px;background:rgba(255,220,0,0.1);border:1px solid rgba(255,220,0,0.3);border-radius:25px;margin:10px 0}
    .coin-badge .amount{font-family:'Orbitron';font-size:18px;font-weight:700;color:var(--accent)}
    .btn{width:100%;max-width:260px;padding:14px 20px;margin:5px 0;font-family:'Orbitron';font-size:12px;font-weight:700;border:none;border-radius:12px;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#0088aa);color:#000}
    .btn-secondary{background:linear-gradient(135deg,var(--secondary),#aa0066);color:#fff}
    .btn-gold{background:linear-gradient(135deg,var(--accent),#aa8800);color:#000}
    .btn-ghost{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.15);color:var(--text-dim)}
    .shop-tabs{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap;justify-content:center}
    .shop-tab{padding:8px 14px;background:transparent;border:1px solid #333;border-radius:8px;font-size:11px;color:var(--text-dim);cursor:pointer}
    .shop-tab.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .shop-list{width:100%;max-height:320px;overflow-y:auto}
    .shop-item{display:flex;align-items:center;padding:12px;margin-bottom:8px;background:var(--card);border:2px solid #2a2a40;border-radius:12px}
    .shop-item.locked{opacity:0.5}
    .shop-item.maxed{border-color:var(--success)}
    .shop-item .icon-box{width:46px;height:46px;background:#1a1a2f;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-right:12px}
    .shop-item .info{flex:1}
    .shop-item .name{font-family:'Orbitron';font-size:12px;color:#fff;margin-bottom:2px}
    .shop-item .desc{font-size:10px;color:var(--text-dim)}
    .shop-item .level{font-family:'Orbitron';font-size:9px;color:var(--accent);margin-top:2px}
    .level-bar{height:4px;background:#1a1a2f;border-radius:2px;margin-top:4px;overflow:hidden}
    .level-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:2px}
    .shop-btn{padding:8px 12px;font-family:'Orbitron';font-size:9px;font-weight:700;border:none;border-radius:8px;cursor:pointer}
    .shop-btn-buy{background:var(--accent);color:#000}
    .shop-btn-buy:disabled{background:#333;color:#666}
    .shop-btn-max{background:#2a2a40;color:var(--success)}
    .unlock-req{font-size:9px;color:var(--secondary);margin-top:2px}
    #toast{position:fixed;bottom:180px;left:50%;transform:translateX(-50%) translateY(50px);padding:12px 24px;background:rgba(0,0,0,0.92);border:1px solid var(--primary);border-radius:25px;font-family:'Orbitron';font-size:11px;color:var(--primary);opacity:0;transition:all 0.3s;z-index:999;pointer-events:none}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .char-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:320px;margin:12px 0}
    .char-card{background:var(--card);border:2px solid #2a2a40;border-radius:12px;padding:8px;text-align:center;cursor:pointer}
    .char-card:hover{border-color:var(--primary)}
    .char-card.selected{border-color:var(--secondary);box-shadow:0 0 15px rgba(255,0,170,0.3)}
    .char-card.locked{opacity:0.5;cursor:not-allowed}
    .char-card .thumb{width:100%;height:80px;border-radius:8px;margin-bottom:5px;overflow:hidden;background:#1a1a2f;display:flex;align-items:center;justify-content:center}
    .char-card .thumb img{width:100%;height:100%;object-fit:cover}
    .char-card .char-name{font-family:'Orbitron';font-size:9px;color:var(--text-dim)}
  </style>
</head>
<body>
  <div id="app">
    <div id="header">
      <div class="hud-group">
        <div class="hud-stat"><span class="label">ë¼ìš´ë“œ</span><span class="value" id="hudRound">1-1</span></div>
        <div class="hud-stat"><span class="label">ì ìˆ˜</span><span class="value" id="hudScore">0</span></div>
      </div>
      <div class="hud-stat"><span class="label">ìƒëª…</span><div class="lives-bar" id="livesBar"></div></div>
      <div class="hud-group">
        <div class="hud-stat"><span class="value gold" id="hudCoins">0</span><span class="label">ì½”ì¸</span></div>
        <button id="pauseBtn">âšâš</button>
      </div>
    </div>
    <div id="gameArea"><canvas id="gameCanvas"></canvas><div id="comboPopup"></div><div id="stagePopup"></div></div>
    <div id="controls">
      <div id="skillBar">
        <button class="skill-btn" id="skill1"><span class="icon">ğŸ”¥</span><span class="lvl" id="skill1Lvl">-</span><div class="cd-fill" id="cd1"></div></button>
        <button class="skill-btn" id="skill2"><span class="icon">âš¡</span><span class="lvl" id="skill2Lvl">-</span><div class="cd-fill" id="cd2"></div></button>
        <button class="skill-btn" id="skill3"><span class="icon">ğŸ’¥</span><span class="lvl" id="skill3Lvl">-</span><div class="cd-fill" id="cd3"></div></button>
        <button class="skill-btn" id="skill4"><span class="icon">â±ï¸</span><span class="lvl" id="skill4Lvl">-</span><div class="cd-fill" id="cd4"></div></button>
      </div>
      <div id="moveBar">
        <button class="dir-btn" id="leftBtn">â—€</button>
        <button id="fireBtn">ë°œì‚¬</button>
        <button class="dir-btn" id="rightBtn">â–¶</button>
      </div>
    </div>

    <!-- Start Screen -->
    <div class="overlay" id="startScreen"><div class="overlay-inner">
      <div class="brand"><h1>ë„¤ì˜¨ ë¸Œë ˆì´ì»¤</h1><p>ì•„ì¼€ì´ë“œ ì—ë””ì…˜</p></div>
      <div class="coin-badge"><span>ğŸª™</span><span class="amount" id="menuCoins">0</span></div>
      <button class="btn btn-primary" id="startBtn">ê²Œì„ ì‹œì‘</button>
      <button class="btn btn-gold" id="shopBtn">ğŸ›’ ìƒì </button>
    </div></div>

    <!-- Character Select -->
    <div class="overlay hidden" id="charSelectScreen"><div class="overlay-inner">
      <div class="brand"><h1 style="font-size:22px;">ìºë¦­í„° ì„ íƒ</h1></div>
      <div class="char-grid" id="charGrid"></div>
      <button class="btn btn-primary" id="playBtn">ì„ íƒ ì™„ë£Œ</button>
      <button class="btn btn-ghost" id="backBtn">â† ë’¤ë¡œ</button>
    </div></div>

    <!-- Shop -->
    <div class="overlay hidden" id="shopScreen"><div class="overlay-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;width:100%;margin-bottom:8px;">
        <div class="brand" style="margin:0;"><h1 style="font-size:20px;">ìƒì </h1></div>
        <div class="coin-badge" style="margin:0;padding:6px 14px;"><span>ğŸª™</span><span class="amount" id="shopCoins">0</span></div>
      </div>
      <div class="shop-tabs">
        <button class="shop-tab active" data-tab="weapon">ğŸ”« ë¬´ê¸°</button>
        <button class="shop-tab" data-tab="skill">âœ¨ ìŠ¤í‚¬</button>
        <button class="shop-tab" data-tab="paddle">ğŸ“ íŒ¨ë“¤</button>
        <button class="shop-tab" data-tab="ball">âšª ê³µ</button>
      </div>
      <div class="shop-list" id="shopList"></div>
      <button class="btn btn-ghost" id="closeShopBtn">â† ë’¤ë¡œ</button>
    </div></div>

    <!-- Pause -->
    <div class="overlay hidden" id="pauseScreen"><div class="overlay-inner">
      <div class="brand"><h1>ì¼ì‹œì •ì§€</h1></div>
      <button class="btn btn-primary" id="resumeBtn">ê³„ì†í•˜ê¸°</button>
      <button class="btn btn-gold" id="pauseShopBtn">ğŸ›’ ìƒì </button>
      <button class="btn btn-ghost" id="restartBtn">ë‹¤ì‹œ ì‹œì‘</button>
      <button class="btn btn-ghost" id="menuBtn">ë©”ì¸ ë©”ë‰´</button>
    </div></div>

    <!-- Game Over -->
    <div class="overlay hidden" id="gameOverScreen"><div class="overlay-inner">
      <div class="brand"><h1>ê²Œì„ ì˜¤ë²„</h1></div>
      <div class="coin-badge"><span>ğŸª™</span><span class="amount" id="earnedCoins">0</span></div>
      <p style="color:var(--text-dim);margin:8px;">ìµœì¢… ì ìˆ˜: <span id="finalScore" style="color:var(--primary);">0</span></p>
      <button class="btn btn-primary" id="retryBtn">ë‹¤ì‹œ ì‹œì‘</button>
      <button class="btn btn-ghost" id="gameOverMenuBtn">ë©”ì¸ ë©”ë‰´</button>
    </div></div>

    <!-- Stage Clear -->
    <div class="overlay hidden" id="stageClearScreen"><div class="overlay-inner">
      <div class="brand"><h1>ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!</h1></div>
      <div id="stageMediaContainer" style="margin:15px 0;min-height:50px;display:flex;justify-content:center;align-items:center;"></div>
      <div class="coin-badge"><span>+</span><span class="amount" id="stageReward">0</span><span>ğŸª™</span></div>
      <button class="btn btn-primary" id="nextStageBtn">ë‹¤ìŒ ìŠ¤í…Œì´ì§€ â†’</button>
    </div></div>

    <div id="toast"></div>
  </div>

<script>
// Supabase ì„¤ì •
var SUPABASE_URL = 'https://ealukkcyetnoouslojaa.supabase.co';

// ========== ê²Œì„ ì„¤ì • ==========
var CFG = {
  STAGES: 7,
  BASE_CD: 10000,
  PADDLE_SPD: 2.5,
  DROP_RATE: 0.2
};

var STG = {
  1:{r:3,c:5,s:2.5,hp:1},
  2:{r:3,c:6,s:2.7,hp:2},
  3:{r:4,c:6,s:2.9,hp:2},
  4:{r:4,c:6,s:3.1,hp:3},
  5:{r:4,c:7,s:3.3,hp:3},
  6:{r:5,c:7,s:3.5,hp:4},
  7:{r:5,c:7,s:3.7,hp:4}
};

// ========== ìƒì  ë°ì´í„° ==========
// ë¬´ê¸°: ë ˆë²¨ì—…í•˜ë©´ ë°œì‚¬ ë°ë¯¸ì§€ ì¦ê°€
var WEAPONS = [
  {id:'w1',name:'ê¸°ë³¸ ìºë…¼',icon:'ğŸ”«',desc:'ê¸°ë³¸ ë¬´ê¸°',baseDmg:1,maxLv:10,basePrice:100,priceUp:50},
  {id:'w2',name:'ë”ë¸” ìƒ·',icon:'ğŸ’¨',desc:'2ë°œ ë™ì‹œ ë°œì‚¬',baseDmg:1,maxLv:10,basePrice:200,priceUp:100,unlockReq:'w1'},
  {id:'w3',name:'ë ˆì´ì €',icon:'âš¡',desc:'ê´€í†µ ë¹”',baseDmg:2,maxLv:10,basePrice:400,priceUp:150,unlockReq:'w2'},
  {id:'w4',name:'ë¯¸ì‚¬ì¼',icon:'ğŸš€',desc:'ìœ ë„ ë¯¸ì‚¬ì¼',baseDmg:3,maxLv:10,basePrice:800,priceUp:200,unlockReq:'w3'}
];

// ìŠ¤í‚¬: ìˆœì„œëŒ€ë¡œ í•´ê¸ˆ (ê´€í†µ â†’ ë²ˆê°œ â†’ í­íƒ„ â†’ ì¿¨íƒ€ì„ê°ì†Œ)
var SKILLS = [
  {id:'s1',name:'ê´€í†µ',icon:'ğŸ”¥',desc:'ê³µì´ ë²½ëŒ ê´€í†µ',maxLv:5,basePrice:300,priceUp:150,duration:3000,durationUp:500},
  {id:'s2',name:'ë²ˆê°œ',icon:'âš¡',desc:'ëœë¤ ë²½ëŒ íŒŒê´´',maxLv:5,basePrice:500,priceUp:200,hits:2,hitsUp:1,unlockReq:'s1'},
  {id:'s3',name:'í­íƒ„',icon:'ğŸ’¥',desc:'ë²”ìœ„ í­ë°œ',maxLv:5,basePrice:800,priceUp:250,radius:60,radiusUp:15,unlockReq:'s2'},
  {id:'s4',name:'ê°€ì†',icon:'â±ï¸',desc:'ì¿¨íƒ€ì„ ê°ì†Œ',maxLv:5,basePrice:1000,priceUp:300,cdReduce:0.1,unlockReq:'s3'}
];

// íŒ¨ë“¤ ì—…ê·¸ë ˆì´ë“œ
var PADDLE_UPGRADES = [
  {id:'p_width',name:'íŒ¨ë“¤ ê¸¸ì´',icon:'ğŸ“',desc:'íŒ¨ë“¤ì´ ê¸¸ì–´ì§',maxLv:10,basePrice:150,priceUp:75,effect:0.05},
  {id:'p_magnet',name:'ìì„',icon:'ğŸ§²',desc:'ì•„ì´í…œ ëŒì–´ë‹¹ê¹€',maxLv:5,basePrice:400,priceUp:200,effect:20},
  {id:'p_catch',name:'ê³µ ì¡ê¸°',icon:'ğŸ–ï¸',desc:'ê³µì„ ì¡ê³  ì¡°ì¤€',maxLv:5,basePrice:500,priceUp:250,effect:0.5},
  {id:'p_speed',name:'ì´ë™ì†ë„',icon:'ğŸ‘Ÿ',desc:'íŒ¨ë“¤ ì´ë™ ë¹¨ë¼ì§',maxLv:10,basePrice:100,priceUp:50,effect:0.3},
  {id:'p_multi',name:'ë©€í‹°ë³¼',icon:'âšª',desc:'ì‹œì‘ ê³µ ê°œìˆ˜',maxLv:3,basePrice:1000,priceUp:500,effect:1}
];

// ê³µ ì—…ê·¸ë ˆì´ë“œ
var BALL_UPGRADES = [
  {id:'b_dmg',name:'ê³µ ë°ë¯¸ì§€',icon:'ğŸ’ª',desc:'ë²½ëŒ ë°ë¯¸ì§€ ì¦ê°€',maxLv:10,basePrice:200,priceUp:100,effect:1},
  {id:'b_speed',name:'ê³µ ì†ë„',icon:'ğŸ’¨',desc:'ê³µì´ ë¹¨ë¼ì§',maxLv:5,basePrice:300,priceUp:150,effect:0.3},
  {id:'b_size',name:'ê³µ í¬ê¸°',icon:'ğŸ”µ',desc:'ê³µì´ ì»¤ì§',maxLv:5,basePrice:250,priceUp:125,effect:1}
];

// ìºë¦­í„°
var CHARACTERS = [
  {id:1,name:'ë¯¸ìŠ¤í„°ë¦¬ ê±¸',unlocked:true},
  {id:2,name:'ì„ ì…‹ ë·°í‹°',unlocked:false},
  {id:3,name:'ë¯¸ë“œë‚˜ì‡',unlocked:false},
  {id:4,name:'ì²´ë¦¬ ë¸”ë¡œì„¬',unlocked:false},
  {id:5,name:'ê³¨ë“  ìŠ¤íƒ€',unlocked:false},
  {id:6,name:'ì‹¤ë²„ ë¬¸',unlocked:false}
];

// ========== ê²Œì„ ìƒíƒœ ==========
var canvas, ctx;
var state = 'menu';
var coins = 0, score = 0, lives = 3, maxLives = 3;
var round = 1, stage = 1, earned = 0;
var selectedChar = 1;
var currentTab = 'weapon';
var returnTo = 'menu';

// ì—…ê·¸ë ˆì´ë“œ ë ˆë²¨ ì €ì¥
var upgrades = {};

// ê²Œì„ ì˜¤ë¸Œì íŠ¸
var paddle, balls, bullets, bricks, items, fx, particles;
var input = {left:false, right:false, fire:false};
var lastFire = 0, skillCD = [0,0,0,0];
var catching = false, catchTimer = 0;

// ========== ì´ˆê¸°í™” ==========
window.onload = function(){
  loadData();
  canvas = document.getElementById('gameCanvas');
  ctx = canvas.getContext('2d');
  resize();
  window.addEventListener('resize', resize);
  setupInput();
  setupButtons();
  updateUI();
  updateSkillButtons();
  requestAnimationFrame(loop);
};

function loadData(){
  coins = parseInt(localStorage.getItem('nb_coins')) || 0;
  round = parseInt(localStorage.getItem('nb_round')) || 1;
  upgrades = JSON.parse(localStorage.getItem('nb_upgrades')) || {};
  selectedChar = parseInt(localStorage.getItem('nb_char')) || 1;
  var chars = JSON.parse(localStorage.getItem('nb_characters'));
  if(chars) CHARACTERS = chars;
}

function saveData(){
  localStorage.setItem('nb_coins', coins);
  localStorage.setItem('nb_round', round);
  localStorage.setItem('nb_upgrades', JSON.stringify(upgrades));
  localStorage.setItem('nb_char', selectedChar);
  localStorage.setItem('nb_characters', JSON.stringify(CHARACTERS));
}

function resize(){
  var area = document.getElementById('gameArea');
  canvas.width = area.clientWidth;
  canvas.height = area.clientHeight;
}

// ========== ì—…ê·¸ë ˆì´ë“œ í—¬í¼ ==========
function getLv(id){ return upgrades[id] || 0; }
function setLv(id, lv){ upgrades[id] = lv; saveData(); }

function isUnlocked(item){
  if(!item.unlockReq) return true;
  return getLv(item.unlockReq) >= 5;
}

function getPrice(item){
  var lv = getLv(item.id);
  return item.basePrice + (lv * item.priceUp);
}

function canBuy(item){
  if(getLv(item.id) >= item.maxLv) return false;
  if(!isUnlocked(item)) return false;
  return coins >= getPrice(item);
}

// ========== UI ì—…ë°ì´íŠ¸ ==========
function updateUI(){
  document.getElementById('menuCoins').textContent = coins.toLocaleString();
  document.getElementById('shopCoins').textContent = coins.toLocaleString();
  document.getElementById('hudCoins').textContent = coins.toLocaleString();
}

function updateHUD(){
  document.getElementById('hudScore').textContent = score.toLocaleString();
  document.getElementById('hudRound').textContent = round + '-' + stage;
  var h = '';
  for(var i = 0; i < maxLives; i++){
    h += '<div class="heart ' + (i < lives ? '' : 'empty') + '"></div>';
  }
  document.getElementById('livesBar').innerHTML = h;
}

function updateSkillButtons(){
  for(var i = 1; i <= 4; i++){
    var skill = SKILLS[i-1];
    var lv = getLv(skill.id);
    var btn = document.getElementById('skill' + i);
    var lvSpan = document.getElementById('skill' + i + 'Lvl');
    
    if(lv > 0){
      btn.classList.add('unlocked');
      lvSpan.textContent = 'Lv.' + lv;
    } else {
      btn.classList.remove('unlocked');
      lvSpan.textContent = '-';
    }
  }
}

function toast(msg){
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 2000);
}

// ========== ìƒì  ë Œë”ë§ ==========
function renderShop(){
  var list = document.getElementById('shopList');
  var items = [];
  
  if(currentTab === 'weapon') items = WEAPONS;
  else if(currentTab === 'skill') items = SKILLS;
  else if(currentTab === 'paddle') items = PADDLE_UPGRADES;
  else if(currentTab === 'ball') items = BALL_UPGRADES;
  
  list.innerHTML = items.map(function(item){
    var lv = getLv(item.id);
    var maxed = lv >= item.maxLv;
    var unlocked = isUnlocked(item);
    var price = getPrice(item);
    var canAfford = coins >= price;
    
    var html = '<div class="shop-item ' + (maxed ? 'maxed' : '') + ' ' + (!unlocked ? 'locked' : '') + '">';
    html += '<div class="icon-box">' + item.icon + '</div>';
    html += '<div class="info">';
    html += '<div class="name">' + item.name + '</div>';
    html += '<div class="desc">' + item.desc + '</div>';
    
    if(unlocked){
      html += '<div class="level">Lv.' + lv + ' / ' + item.maxLv + '</div>';
      html += '<div class="level-bar"><div class="level-fill" style="width:' + (lv/item.maxLv*100) + '%"></div></div>';
    } else {
      var reqItem = items.find(function(x){ return x.id === item.unlockReq; });
      html += '<div class="unlock-req">ğŸ”’ ' + (reqItem ? reqItem.name : '') + ' Lv.5 í•„ìš”</div>';
    }
    
    html += '</div>';
    
    if(maxed){
      html += '<button class="shop-btn shop-btn-max" disabled>MAX</button>';
    } else if(unlocked){
      html += '<button class="shop-btn shop-btn-buy" data-id="' + item.id + '" ' + (canAfford ? '' : 'disabled') + '>ğŸª™' + price + '</button>';
    }
    
    html += '</div>';
    return html;
  }).join('');
  
  list.querySelectorAll('.shop-btn-buy').forEach(function(btn){
    btn.onclick = function(){ buyUpgrade(btn.dataset.id); };
  });
}

function buyUpgrade(id){
  var allItems = WEAPONS.concat(SKILLS).concat(PADDLE_UPGRADES).concat(BALL_UPGRADES);
  var item = allItems.find(function(x){ return x.id === id; });
  if(!item || !canBuy(item)) return;
  
  coins -= getPrice(item);
  setLv(id, getLv(id) + 1);
  updateUI();
  updateSkillButtons();
  renderShop();
  toast(item.name + ' Lv.' + getLv(id) + ' ì—…ê·¸ë ˆì´ë“œ!');
}

// ========== ê²Œì„ ë¡œì§ ==========
function getStageCfg(){
  var cfg = STG[stage] || STG[7];
  var bonus = (round - 1) * 0.2;
  return {
    r: Math.min(8, cfg.r + Math.floor(bonus)),
    c: Math.min(9, cfg.c),
    s: cfg.s + bonus * 0.3,
    hp: cfg.hp + Math.floor(bonus * 2)
  };
}

function initGame(){
  var cfg = getStageCfg();
  var pWidth = canvas.width * 0.12 * (1 + getLv('p_width') * 0.05);
  
  paddle = {
    w: pWidth,
    h: 14,
    x: canvas.width/2 - pWidth/2,
    y: canvas.height - 25,
    speed: CFG.PADDLE_SPD + getLv('p_speed') * 0.3
  };
  
  var ballCount = 1 + getLv('p_multi');
  balls = [];
  for(var i = 0; i < ballCount; i++){
    balls.push(makeBall());
  }
  
  bullets = [];
  items = [];
  fx = [];
  particles = [];
  catching = false;
  
  makeBricks();
}

function makeBall(x, y, dx, dy){
  var baseSpeed = getStageCfg().s + getLv('b_speed') * 0.3;
  var size = 6 + getLv('b_size');
  return {
    x: x !== undefined ? x : canvas.width/2,
    y: y !== undefined ? y : paddle.y - 10,
    r: size,
    dx: dx !== undefined ? dx : 0,
    dy: dy !== undefined ? dy : 0,
    speed: baseSpeed,
    attached: dx === undefined,
    piercing: false,
    pierceTime: 0,
    dmg: 1 + getLv('b_dmg')
  };
}

function makeBricks(){
  bricks = [];
  var cfg = getStageCfg();
  var pad = 8;
  var bw = (canvas.width - pad*2) / cfg.c - 3;
  var bh = 22;
  
  for(var r = 0; r < cfg.r; r++){
    for(var c = 0; c < cfg.c; c++){
      var hp = cfg.hp + Math.floor(Math.random() * 2);
      var hue = (r * 40 + c * 20 + stage * 30) % 360;
      bricks.push({
        x: pad + c * (bw + 3),
        y: 50 + r * (bh + 3),
        w: bw,
        h: bh,
        hp: hp,
        maxHp: hp,
        hue: hue
      });
    }
  }
}

function update(){
  if(state !== 'playing') return;
  
  // íŒ¨ë“¤ ì´ë™
  if(input.left) paddle.x = Math.max(0, paddle.x - paddle.speed);
  if(input.right) paddle.x = Math.min(canvas.width - paddle.w, paddle.x + paddle.speed);
  
  // ë°œì‚¬
  if(input.fire){
    if(catching){
      // ê³µ ì¡ê¸° í•´ì œ
      catching = false;
      balls.forEach(function(b){
        if(b.attached){
          b.attached = false;
          b.dx = (Math.random() - 0.5) * 4;
          b.dy = -b.speed;
        }
      });
    } else {
      balls.forEach(function(b){
        if(b.attached){
          b.attached = false;
          b.dx = (Math.random() - 0.5) * 3;
          b.dy = -b.speed;
        }
      });
      fireWeapon();
    }
  }
  
  updateBalls();
  updateBullets();
  updateItems();
  updateFx();
  updateSkillCD();
  updateHUD();
  
  // ìŠ¹ë¦¬/íŒ¨ë°° ì²´í¬
  if(bricks.length === 0) stageClear();
  if(balls.length === 0){
    lives--;
    if(lives <= 0) gameOver();
    else balls.push(makeBall());
  }
}

function updateBalls(){
  var magnetRange = getLv('p_magnet') * 20;
  var catchLv = getLv('p_catch');
  
  for(var i = balls.length - 1; i >= 0; i--){
    var b = balls[i];
    
    if(b.attached){
      b.x = paddle.x + paddle.w/2;
      b.y = paddle.y - b.r;
      continue;
    }
    
    // ê´€í†µ íƒ€ì´ë¨¸
    if(b.piercing){
      b.pierceTime -= 16;
      if(b.pierceTime <= 0) b.piercing = false;
    }
    
    b.x += b.dx;
    b.y += b.dy;
    
    // ë²½ ì¶©ëŒ
    if(b.x <= b.r){ b.x = b.r; b.dx = Math.abs(b.dx); }
    if(b.x >= canvas.width - b.r){ b.x = canvas.width - b.r; b.dx = -Math.abs(b.dx); }
    if(b.y <= b.r){ b.y = b.r; b.dy = Math.abs(b.dy); }
    
    // íŒ¨ë“¤ ì¶©ëŒ
    if(b.dy > 0 && b.y + b.r >= paddle.y && b.y - b.r <= paddle.y + paddle.h &&
       b.x >= paddle.x - b.r && b.x <= paddle.x + paddle.w + b.r){
      
      if(catchLv > 0 && !catching){
        // ê³µ ì¡ê¸°
        catching = true;
        b.attached = true;
        b.dx = 0;
        b.dy = 0;
      } else {
        b.y = paddle.y - b.r;
        b.dy = -Math.abs(b.dy);
        var hitPos = (b.x - paddle.x) / paddle.w;
        b.dx = (hitPos - 0.5) * b.speed * 1.5;
      }
    }
    
    // ë²½ëŒ ì¶©ëŒ
    for(var j = bricks.length - 1; j >= 0; j--){
      var br = bricks[j];
      if(b.x + b.r > br.x && b.x - b.r < br.x + br.w &&
         b.y + b.r > br.y && b.y - b.r < br.y + br.h){
        
        hitBrick(br, j, b.dmg);
        
        if(!b.piercing){
          // ë°˜ì‚¬
          var ox = Math.min(b.x + b.r - br.x, br.x + br.w - (b.x - b.r));
          var oy = Math.min(b.y + b.r - br.y, br.y + br.h - (b.y - b.r));
          if(ox < oy) b.dx *= -1;
          else b.dy *= -1;
        }
        break;
      }
    }
    
    // í™”ë©´ ë°–
    if(b.y > canvas.height + 20){
      balls.splice(i, 1);
    }
  }
}

function fireWeapon(){
  var now = Date.now();
  var fireRate = 400;
  if(now - lastFire < fireRate) return;
  lastFire = now;
  
  var wpnLv = Math.max(1, getLv('w1'), getLv('w2'), getLv('w3'), getLv('w4'));
  var dmg = wpnLv;
  var cx = paddle.x + paddle.w/2;
  var cy = paddle.y;
  
  if(getLv('w4') > 0){
    // ë¯¸ì‚¬ì¼
    bullets.push({x:cx, y:cy, dx:0, dy:-8, dmg:dmg*3, type:'missile', homing:true});
  } else if(getLv('w3') > 0){
    // ë ˆì´ì €
    bullets.push({x:cx, y:cy, dx:0, dy:-12, dmg:dmg*2, type:'laser', pierce:true, w:6, h:20});
  } else if(getLv('w2') > 0){
    // ë”ë¸”ìƒ·
    bullets.push({x:cx-10, y:cy, dx:-1, dy:-10, dmg:dmg, type:'normal'});
    bullets.push({x:cx+10, y:cy, dx:1, dy:-10, dmg:dmg, type:'normal'});
  } else if(getLv('w1') > 0){
    // ê¸°ë³¸
    bullets.push({x:cx, y:cy, dx:0, dy:-10, dmg:dmg, type:'normal'});
  }
}

function updateBullets(){
  for(var i = bullets.length - 1; i >= 0; i--){
    var b = bullets[i];
    
    // ìœ ë„
    if(b.homing && bricks.length > 0){
      var target = bricks[0];
      var tx = target.x + target.w/2;
      var ty = target.y + target.h/2;
      var angle = Math.atan2(ty - b.y, tx - b.x);
      b.dx += Math.cos(angle) * 0.5;
      b.dy += Math.sin(angle) * 0.5;
      var spd = Math.sqrt(b.dx*b.dx + b.dy*b.dy);
      if(spd > 10){ b.dx = b.dx/spd*10; b.dy = b.dy/spd*10; }
    }
    
    b.x += b.dx;
    b.y += b.dy;
    
    if(b.y < -20 || b.y > canvas.height || b.x < 0 || b.x > canvas.width){
      bullets.splice(i, 1);
      continue;
    }
    
    // ë²½ëŒ ì¶©ëŒ
    for(var j = bricks.length - 1; j >= 0; j--){
      var br = bricks[j];
      var bw = b.w || 8;
      var bh = b.h || 8;
      if(b.x + bw/2 > br.x && b.x - bw/2 < br.x + br.w &&
         b.y + bh/2 > br.y && b.y - bh/2 < br.y + br.h){
        hitBrick(br, j, b.dmg);
        if(!b.pierce){
          bullets.splice(i, 1);
        }
        break;
      }
    }
  }
}

function hitBrick(br, idx, dmg){
  br.hp -= dmg;
  
  // íŒŒí‹°í´
  for(var i = 0; i < 4; i++){
    particles.push({
      x: br.x + br.w/2,
      y: br.y + br.h/2,
      dx: (Math.random()-0.5)*5,
      dy: (Math.random()-0.5)*5,
      life: 15,
      hue: br.hue
    });
  }
  
  if(br.hp <= 0){
    destroyBrick(br, idx);
  }
}

function destroyBrick(br, idx){
  var reward = 5 + round + stage;
  coins += reward;
  earned += reward;
  score += 10;
  
  // ì•„ì´í…œ ë“œë¡­
  if(Math.random() < CFG.DROP_RATE){
    spawnItem(br.x + br.w/2, br.y + br.h/2);
  }
  
  bricks.splice(idx, 1);
  updateUI();
}

function spawnItem(x, y){
  var types = [
    {t:'life', icon:'â™¥', color:'#f55'},
    {t:'coin', icon:'ğŸª™', color:'#fd0'},
    {t:'power', icon:'â¬†', color:'#0ff'}
  ];
  var item = types[Math.floor(Math.random() * types.length)];
  items.push({x:x, y:y, dy:2, type:item.t, icon:item.icon, color:item.color});
}

function updateItems(){
  var magnetRange = getLv('p_magnet') * 20;
  
  for(var i = items.length - 1; i >= 0; i--){
    var it = items[i];
    it.y += it.dy;
    
    // ìì„
    if(magnetRange > 0){
      var dx = paddle.x + paddle.w/2 - it.x;
      var dy = paddle.y - it.y;
      var dist = Math.sqrt(dx*dx + dy*dy);
      if(dist < magnetRange){
        it.x += dx * 0.1;
        it.y += dy * 0.1;
      }
    }
    
    // íŒ¨ë“¤ ì¶©ëŒ
    if(it.y + 10 >= paddle.y && it.y - 10 <= paddle.y + paddle.h &&
       it.x >= paddle.x - 10 && it.x <= paddle.x + paddle.w + 10){
      collectItem(it);
      items.splice(i, 1);
      continue;
    }
    
    if(it.y > canvas.height + 20){
      items.splice(i, 1);
    }
  }
}

function collectItem(it){
  if(it.type === 'life'){
    lives = Math.min(lives + 1, maxLives);
    toast('+1 ìƒëª…!');
  } else if(it.type === 'coin'){
    coins += 20;
    earned += 20;
    toast('+20 ì½”ì¸!');
  } else if(it.type === 'power'){
    balls.forEach(function(b){ b.dmg += 1; });
    toast('ë°ë¯¸ì§€ UP!');
  }
  updateUI();
}

function updateFx(){
  for(var i = fx.length - 1; i >= 0; i--){
    fx[i].r += 8;
    if(fx[i].r >= fx[i].max) fx.splice(i, 1);
  }
  for(var i = particles.length - 1; i >= 0; i--){
    var p = particles[i];
    p.x += p.dx;
    p.y += p.dy;
    p.dy += 0.2;
    p.life--;
    if(p.life <= 0) particles.splice(i, 1);
  }
}

// ========== ìŠ¤í‚¬ ==========
function useSkill(n){
  if(state !== 'playing') return;
  var skill = SKILLS[n-1];
  var lv = getLv(skill.id);
  if(lv <= 0) return;
  
  var now = Date.now();
  var cdReduce = 1 - (getLv('s4') * 0.1);
  var cd = CFG.BASE_CD * cdReduce;
  if(now - skillCD[n-1] < cd) return;
  
  skillCD[n-1] = now;
  
  if(n === 1){
    // ê´€í†µ
    var dur = skill.duration + lv * skill.durationUp;
    balls.forEach(function(b){
      b.piercing = true;
      b.pierceTime = dur;
    });
    toast('ê´€í†µ!');
  } else if(n === 2){
    // ë²ˆê°œ
    var hits = skill.hits + lv * skill.hitsUp;
    for(var i = 0; i < hits && bricks.length > 0; i++){
      var idx = Math.floor(Math.random() * bricks.length);
      var br = bricks[idx];
      hitBrick(br, idx, 999);
    }
    toast('ë²ˆê°œ!');
  } else if(n === 3){
    // í­íƒ„
    var radius = skill.radius + lv * skill.radiusUp;
    var cx = canvas.width/2;
    var cy = canvas.height/3;
    fx.push({x:cx, y:cy, r:0, max:radius});
    for(var i = bricks.length - 1; i >= 0; i--){
      var br = bricks[i];
      var dist = Math.hypot(br.x + br.w/2 - cx, br.y + br.h/2 - cy);
      if(dist < radius){
        hitBrick(br, i, 999);
      }
    }
    toast('í­íƒ„!');
  } else if(n === 4){
    // ì¿¨íƒ€ì„ ë¦¬ì…‹
    skillCD = [0,0,0,0];
    toast('ì¿¨íƒ€ì„ ì´ˆê¸°í™”!');
  }
}

function updateSkillCD(){
  var now = Date.now();
  var cdReduce = 1 - (getLv('s4') * 0.1);
  var cd = CFG.BASE_CD * cdReduce;
  
  for(var i = 0; i < 4; i++){
    var el = document.getElementById('cd' + (i+1));
    var elapsed = now - skillCD[i];
    el.style.height = elapsed < cd ? ((cd - elapsed)/cd * 100) + '%' : '0%';
  }
}

// ========== ë Œë”ë§ ==========
function render(){
  // ë°°ê²½
  ctx.fillStyle = '#08080f';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // ê·¸ë¦¬ë“œ
  ctx.strokeStyle = 'rgba(0,240,255,0.03)';
  for(var x = 0; x < canvas.width; x += 30){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke();
  }
  for(var y = 0; y < canvas.height; y += 30){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke();
  }
  
  if(state !== 'playing' && state !== 'paused') return;
  
  // í­ë°œ
  fx.forEach(function(e){
    var g = ctx.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r);
    g.addColorStop(0,'rgba(255,100,0,0.6)');
    g.addColorStop(1,'rgba(255,0,0,0)');
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fill();
  });
  
  // ë²½ëŒ
  bricks.forEach(function(br){
    var pct = br.hp / br.maxHp;
    ctx.fillStyle = 'hsl('+br.hue+',60%,'+(30+pct*30)+'%)';
    ctx.fillRect(br.x, br.y, br.w, br.h);
    
    // ê¸ˆ
    if(pct < 1){
      ctx.strokeStyle = 'rgba(0,0,0,0.5)';
      ctx.lineWidth = 1;
      for(var i = 0; i < (1-pct)*5; i++){
        ctx.beginPath();
        ctx.moveTo(br.x + Math.random()*br.w, br.y);
        ctx.lineTo(br.x + Math.random()*br.w, br.y + br.h);
        ctx.stroke();
      }
    }
    
    // HP í‘œì‹œ
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 10px Orbitron';
    ctx.textAlign = 'center';
    ctx.fillText(br.hp, br.x + br.w/2, br.y + br.h/2 + 4);
  });
  
  // ì•„ì´í…œ
  items.forEach(function(it){
    ctx.fillStyle = it.color;
    ctx.beginPath();
    ctx.arc(it.x, it.y, 12, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#000';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(it.icon, it.x, it.y);
  });
  
  // ì´ì•Œ
  bullets.forEach(function(b){
    ctx.fillStyle = b.type === 'laser' ? '#f0f' : b.type === 'missile' ? '#f60' : '#0ff';
    if(b.w){
      ctx.fillRect(b.x - b.w/2, b.y - b.h/2, b.w, b.h);
    } else {
      ctx.beginPath();
      ctx.arc(b.x, b.y, 4, 0, Math.PI*2);
      ctx.fill();
    }
  });
  
  // ê³µ
  balls.forEach(function(b){
    ctx.fillStyle = b.piercing ? '#f80' : '#fff';
    ctx.shadowBlur = 10;
    ctx.shadowColor = b.piercing ? '#f80' : '#0ff';
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
    ctx.fill();
    ctx.shadowBlur = 0;
  });
  
  // íŒ¨ë“¤
  ctx.fillStyle = '#0ff';
  ctx.shadowBlur = 15;
  ctx.shadowColor = '#0ff';
  ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h);
  ctx.shadowBlur = 0;
  
  // íŒŒí‹°í´
  particles.forEach(function(p){
    ctx.globalAlpha = p.life / 15;
    ctx.fillStyle = 'hsl('+p.hue+',70%,60%)';
    ctx.beginPath();
    ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

// ========== ê²Œì„ íë¦„ ==========
function hideAll(){
  ['startScreen','charSelectScreen','shopScreen','pauseScreen','gameOverScreen','stageClearScreen'].forEach(function(id){
    document.getElementById(id).classList.add('hidden');
  });
}

function showStart(){
  hideAll();
  updateUI();
  document.getElementById('startScreen').classList.remove('hidden');
  state = 'menu';
}

function showCharSelect(){
  hideAll();
  renderCharGrid();
  document.getElementById('charSelectScreen').classList.remove('hidden');
}

function renderCharGrid(){
  var grid = document.getElementById('charGrid');
  grid.innerHTML = '';
  CHARACTERS.forEach(function(c){
    var div = document.createElement('div');
    div.className = 'char-card' + (c.unlocked ? '' : ' locked') + (selectedChar === c.id ? ' selected' : '');
    var thumbUrl = SUPABASE_URL + '/storage/v1/object/public/thumbs/char_' + c.id + '.jpg';
    div.innerHTML = '<div class="thumb"><img src="' + thumbUrl + '" onerror="this.onerror=null;this.src=\'' + SUPABASE_URL + '/storage/v1/object/public/thumbs/char_' + c.id + '.png\'"></div><div class="char-name">'+(c.unlocked ? c.name : 'ğŸ”’')+'</div>';
    if(c.unlocked){
      div.onclick = function(){
        selectedChar = c.id;
        saveData();
        renderCharGrid();
      };
    }
    grid.appendChild(div);
  });
}

function startGame(){
  hideAll();
  state = 'playing';
  score = 0;
  lives = maxLives;
  stage = 1;
  earned = 0;
  skillCD = [0,0,0,0];
  initGame();
}

function stageClear(){
  state = 'stageclear';
  var reward = 50 + stage * 20;
  coins += reward;
  earned += reward;
  document.getElementById('stageReward').textContent = reward;
  saveData();
  updateUI();
  
  // ì„œë²„ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
  loadStageMedia(round, stage);
  
  if(stage >= CFG.STAGES){
    // ë¼ìš´ë“œ í´ë¦¬ì–´
    round++;
    stage = 1;
    // ìºë¦­í„° í•´ê¸ˆ
    if(round <= CHARACTERS.length){
      CHARACTERS[round-1].unlocked = true;
    }
    saveData();
  }
  
  document.getElementById('stageClearScreen').classList.remove('hidden');
}

function loadStageMedia(r, s){
  var container = document.getElementById('stageMediaContainer');
  if(!container) return;
  
  var key = 'r' + r + '_s' + s;
  var baseUrl = SUPABASE_URL + '/storage/v1/object/public/secret/' + key;
  
  // jpg ë¨¼ì € ì‹œë„
  var img = new Image();
  img.onload = function(){
    container.innerHTML = '<img src="' + baseUrl + '.jpg" style="max-width:100%;max-height:200px;border-radius:12px;">';
  };
  img.onerror = function(){
    // png ì‹œë„
    var img2 = new Image();
    img2.onload = function(){
      container.innerHTML = '<img src="' + baseUrl + '.png" style="max-width:100%;max-height:200px;border-radius:12px;">';
    };
    img2.onerror = function(){
      // mp4 ì‹œë„
      container.innerHTML = '<video src="' + baseUrl + '.mp4" style="max-width:100%;max-height:200px;border-radius:12px;" autoplay loop muted playsinline onerror="this.style.display=\'none\'"></video>';
    };
    img2.src = baseUrl + '.png';
  };
  img.src = baseUrl + '.jpg';
}

function nextStage(){
  hideAll();
  stage++;
  initGame();
  state = 'playing';
}

function gameOver(){
  state = 'gameover';
  document.getElementById('earnedCoins').textContent = earned;
  document.getElementById('finalScore').textContent = score;
  saveData();
  document.getElementById('gameOverScreen').classList.remove('hidden');
}

function showShop(from){
  returnTo = from || 'menu';
  hideAll();
  updateUI();
  renderShop();
  document.getElementById('shopScreen').classList.remove('hidden');
}

function closeShop(){
  hideAll();
  if(returnTo === 'pause'){
    document.getElementById('pauseScreen').classList.remove('hidden');
  } else {
    showStart();
  }
}

// ========== ì…ë ¥ ==========
function setupInput(){
  var L = document.getElementById('leftBtn');
  var R = document.getElementById('rightBtn');
  var F = document.getElementById('fireBtn');
  
  L.ontouchstart = function(e){ e.preventDefault(); input.left = true; };
  L.ontouchend = function(e){ e.preventDefault(); input.left = false; };
  R.ontouchstart = function(e){ e.preventDefault(); input.right = true; };
  R.ontouchend = function(e){ e.preventDefault(); input.right = false; };
  F.ontouchstart = function(e){ e.preventDefault(); input.fire = true; };
  F.ontouchend = function(e){ e.preventDefault(); input.fire = false; };
  
  L.onmousedown = function(){ input.left = true; };
  L.onmouseup = L.onmouseleave = function(){ input.left = false; };
  R.onmousedown = function(){ input.right = true; };
  R.onmouseup = R.onmouseleave = function(){ input.right = false; };
  F.onmousedown = function(){ input.fire = true; };
  F.onmouseup = F.onmouseleave = function(){ input.fire = false; };
  
  document.onkeydown = function(e){
    if(e.key === 'ArrowLeft') input.left = true;
    if(e.key === 'ArrowRight') input.right = true;
    if(e.key === ' ' || e.key === 'z'){ input.fire = true; e.preventDefault(); }
    if(e.key >= '1' && e.key <= '4') useSkill(parseInt(e.key));
  };
  document.onkeyup = function(e){
    if(e.key === 'ArrowLeft') input.left = false;
    if(e.key === 'ArrowRight') input.right = false;
    if(e.key === ' ' || e.key === 'z') input.fire = false;
  };
  
  // ìŠ¤í‚¬ ë²„íŠ¼
  for(var i = 1; i <= 4; i++){
    (function(n){
      document.getElementById('skill' + n).onclick = function(){ useSkill(n); };
    })(i);
  }
}

function setupButtons(){
  document.getElementById('startBtn').onclick = showCharSelect;
  document.getElementById('shopBtn').onclick = function(){ showShop('menu'); };
  document.getElementById('playBtn').onclick = startGame;
  document.getElementById('backBtn').onclick = showStart;
  
  document.getElementById('closeShopBtn').onclick = closeShop;
  document.querySelectorAll('.shop-tab').forEach(function(tab){
    tab.onclick = function(){
      document.querySelectorAll('.shop-tab').forEach(function(t){ t.classList.remove('active'); });
      tab.classList.add('active');
      currentTab = tab.dataset.tab;
      renderShop();
    };
  });
  
  document.getElementById('pauseBtn').onclick = function(){
    if(state === 'playing'){
      state = 'paused';
      document.getElementById('pauseScreen').classList.remove('hidden');
    }
  };
  document.getElementById('resumeBtn').onclick = function(){
    hideAll();
    state = 'playing';
  };
  document.getElementById('pauseShopBtn').onclick = function(){ showShop('pause'); };
  document.getElementById('restartBtn').onclick = function(){ hideAll(); startGame(); };
  document.getElementById('menuBtn').onclick = showStart;
  
  document.getElementById('retryBtn').onclick = function(){ hideAll(); startGame(); };
  document.getElementById('gameOverMenuBtn').onclick = showStart;
  
  document.getElementById('nextStageBtn').onclick = nextStage;
}
</script>
</body>
</html>
