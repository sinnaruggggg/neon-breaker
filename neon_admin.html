<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì˜¨ ë¸Œë ˆì´ì»¤ - ê´€ë¦¬ì</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--primary:#00f0ff;--secondary:#ff00aa;--accent:#ffdd00;--success:#00ff88;--danger:#ff4466;--bg:#0a0a12;--card:#12121f;--text:#fff;--text-dim:#7788aa}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);min-height:100vh;padding:15px}
    .container{max-width:800px;margin:0 auto}
    h1{font-family:'Orbitron';font-size:22px;text-align:center;margin-bottom:6px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{text-align:center;color:var(--text-dim);margin-bottom:20px;font-size:12px}
    .tabs{display:flex;gap:5px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
    .tab{padding:10px 18px;background:var(--card);border:2px solid #2a2a40;border-radius:8px;font-family:'Orbitron';font-size:10px;color:var(--text-dim);cursor:pointer}
    .tab:hover{border-color:var(--primary)}
    .tab.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .panel{display:none;background:var(--card);border:2px solid #2a2a40;border-radius:12px;padding:15px}
    .panel.active{display:block}
    .section{margin-bottom:18px}
    .section-title{font-family:'Orbitron';font-size:12px;color:var(--secondary);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(255,0,170,0.2)}
    .upload-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .upload-card{background:#0a0a12;border:2px solid #2a2a40;border-radius:10px;padding:10px;text-align:center}
    .upload-card.has-image{border-color:var(--success)}
    .upload-card .preview{width:100%;height:80px;background:#050508;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .upload-card .preview img,.upload-card .preview video{width:100%;height:100%;object-fit:cover}
    .upload-card .preview .placeholder{color:#333;font-size:28px}
    .upload-card .label{font-family:'Orbitron';font-size:9px;color:var(--text-dim);margin-bottom:6px}
    .upload-card input[type="file"]{display:none}
    .upload-card .upload-btn{width:100%;padding:6px;background:var(--primary);border:none;border-radius:6px;font-family:'Orbitron';font-size:9px;color:#000;cursor:pointer}
    .upload-card .upload-btn:hover{filter:brightness(1.1)}
    .upload-card .delete-btn{position:absolute;top:4px;right:4px;width:20px;height:20px;background:var(--danger);border:none;border-radius:50%;color:#fff;font-size:10px;cursor:pointer;display:none}
    .upload-card:hover .delete-btn{display:block}
    .round-tabs{display:flex;gap:5px;margin-bottom:12px;flex-wrap:wrap}
    .round-tab{padding:6px 14px;background:#1a1a2f;border:1px solid #2a2a40;border-radius:6px;font-family:'Orbitron';font-size:9px;color:var(--text-dim);cursor:pointer}
    .round-tab.active{border-color:var(--accent);color:var(--accent)}
    .btn{padding:8px 16px;font-family:'Orbitron';font-size:10px;border:none;border-radius:6px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#000}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #2a2a40;color:var(--text-dim)}
    .row{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .input{padding:8px 12px;background:#0a0a12;border:1px solid #2a2a40;border-radius:6px;color:#fff;font-size:12px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:12px}
    .stat-card{background:#0a0a12;border:1px solid #2a2a40;border-radius:8px;padding:10px;text-align:center}
    .stat-card .value{font-family:'Orbitron';font-size:18px;color:var(--accent)}
    .stat-card .label{font-size:9px;color:var(--text-dim)}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);padding:10px 20px;background:rgba(0,0,0,0.95);border:1px solid var(--success);border-radius:20px;font-family:'Orbitron';font-size:10px;color:var(--success);opacity:0;transition:all 0.3s;z-index:999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.error{border-color:var(--danger);color:var(--danger)}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid #333;border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .status-bar{padding:10px;background:#0a0a12;border-radius:8px;margin-bottom:15px;font-size:11px;display:flex;align-items:center;gap:10px}
    .status-dot{width:8px;height:8px;border-radius:50%;background:var(--danger)}
    .status-dot.connected{background:var(--success)}
  </style>
</head>
<body>
  <div class="container">
    <h1>âš™ï¸ ë„¤ì˜¨ ë¸Œë ˆì´ì»¤ ê´€ë¦¬ì</h1>
    <p class="subtitle">ì´ë¯¸ì§€/ì˜ìƒ ì—…ë¡œë“œ ë° ê²Œì„ ì„¤ì •</p>
    
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Supabase ì—°ê²° ì¤‘...</span>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="thumbs">ğŸ‘¤ ìºë¦­í„° ì¸ë„¤ì¼</button>
      <button class="tab" data-tab="stages">ğŸ¬ ìŠ¤í…Œì´ì§€ ì´ë¯¸ì§€</button>
      <button class="tab" data-tab="data">ğŸ’¾ ë°ì´í„°</button>
    </div>

    <!-- Thumbs Panel -->
    <div class="panel active" id="thumbsPanel">
      <div class="section">
        <div class="section-title">ğŸ‘¤ ìºë¦­í„° ì¸ë„¤ì¼ (ì•ˆì „í•œ ì´ë¯¸ì§€)</div>
        <p style="color:var(--text-dim);font-size:11px;margin-bottom:12px;">ê²Œì„ ì‹œì‘ ì‹œ ìºë¦­í„° ì„ íƒ í™”ë©´ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        <div class="upload-grid" id="thumbsGrid"></div>
      </div>
    </div>

    <!-- Stages Panel -->
    <div class="panel" id="stagesPanel">
      <div class="section">
        <div class="section-title">ğŸ¬ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì´ë¯¸ì§€ (secret í´ë”)</div>
        <p style="color:var(--text-dim);font-size:11px;margin-bottom:12px;">ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ í‘œì‹œë©ë‹ˆë‹¤. JPG, PNG, MP4 ì§€ì›.</p>
        <div class="round-tabs" id="roundTabs"></div>
        <div class="upload-grid" id="stagesGrid"></div>
      </div>
    </div>

    <!-- Data Panel -->
    <div class="panel" id="dataPanel">
      <div class="section">
        <div class="section-title">ğŸ“Š ê²Œì„ ë°ì´í„°</div>
        <div class="stats-grid" id="statsGrid"></div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ’° ì½”ì¸ ê´€ë¦¬</div>
        <div class="row">
          <input type="number" class="input" id="coinInput" style="width:100px;">
          <button class="btn btn-primary" id="setCoinsBtn">ì„¤ì •</button>
          <button class="btn btn-ghost" id="add1kBtn">+1ì²œ</button>
          <button class="btn btn-ghost" id="add10kBtn">+1ë§Œ</button>
        </div>
      </div>
      <div class="section">
        <div class="section-title">âš ï¸ ìœ„í—˜</div>
        <div class="row">
          <button class="btn btn-primary" id="unlockAllBtn">ğŸ”“ ì „ì²´ í•´ê¸ˆ</button>
          <button class="btn btn-danger" id="resetBtn">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

<script>
// Supabase ì„¤ì •
var SUPABASE_URL = 'https://ealukkcyetnoouslojaa.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhbHVra2N5ZXRub291c2xvamFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5ODkwNjAsImV4cCI6MjA4NDU2NTA2MH0.SQ77IL13Da3FczDKEtEcHwkQCRDKCA1-RaTBjQ5SvE0';

var supabase;
var currentRound = 1;
var maxRounds = 6;
var stagesPerRound = 7;
var maxChars = 6;

// ì´ˆê¸°í™”
window.onload = async function(){
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  await checkConnection();
  setupTabs();
  setupEvents();
  renderThumbs();
  renderRoundTabs();
  renderStages();
  renderStats();
};

async function checkConnection(){
  try {
    var { data, error } = await supabase.storage.listBuckets();
    if(error) throw error;
    
    // thumbs ë²„í‚· í™•ì¸/ìƒì„±
    var thumbsBucket = data.find(b => b.name === 'thumbs');
    if(!thumbsBucket){
      await supabase.storage.createBucket('thumbs', { public: true });
    }
    
    // secret ë²„í‚· í™•ì¸/ìƒì„±
    var secretBucket = data.find(b => b.name === 'secret');
    if(!secretBucket){
      await supabase.storage.createBucket('secret', { public: true });
    }
    
    document.getElementById('statusDot').classList.add('connected');
    document.getElementById('statusText').textContent = 'Supabase ì—°ê²°ë¨';
  } catch(e) {
    document.getElementById('statusText').textContent = 'Supabase ì—°ê²° ì‹¤íŒ¨: ' + e.message;
    toast('Supabase ì—°ê²° ì‹¤íŒ¨!', true);
  }
}

function setupTabs(){
  document.querySelectorAll('.tab').forEach(function(tab){
    tab.onclick = function(){
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
    };
  });
}

function setupEvents(){
  document.getElementById('setCoinsBtn').onclick = function(){
    var coins = parseInt(document.getElementById('coinInput').value) || 0;
    localStorage.setItem('nb_coins', coins);
    renderStats();
    toast('ì½”ì¸ ì„¤ì •ë¨!');
  };
  document.getElementById('add1kBtn').onclick = function(){
    var coins = (parseInt(localStorage.getItem('nb_coins')) || 0) + 1000;
    localStorage.setItem('nb_coins', coins);
    document.getElementById('coinInput').value = coins;
    renderStats();
    toast('+1,000!');
  };
  document.getElementById('add10kBtn').onclick = function(){
    var coins = (parseInt(localStorage.getItem('nb_coins')) || 0) + 10000;
    localStorage.setItem('nb_coins', coins);
    document.getElementById('coinInput').value = coins;
    renderStats();
    toast('+10,000!');
  };
  document.getElementById('unlockAllBtn').onclick = function(){
    var chars = [];
    for(var i = 1; i <= maxChars; i++) chars.push(i);
    localStorage.setItem('nb_unlocked_chars', JSON.stringify(chars));
    toast('ì „ì²´ í•´ê¸ˆ!');
  };
  document.getElementById('resetBtn').onclick = function(){
    if(confirm('ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”?')){
      localStorage.clear();
      location.reload();
    }
  };
}

// ìºë¦­í„° ì¸ë„¤ì¼
async function renderThumbs(){
  var grid = document.getElementById('thumbsGrid');
  var html = '';
  
  for(var i = 1; i <= maxChars; i++){
    html += '<div class="upload-card" data-char="' + i + '">';
    html += '<div class="preview" id="thumbPreview' + i + '"><span class="placeholder">ğŸ‘¤</span></div>';
    html += '<div class="label">ìºë¦­í„° ' + i + '</div>';
    html += '<input type="file" accept="image/*" id="thumbInput' + i + '">';
    html += '<button class="upload-btn" onclick="document.getElementById(\'thumbInput' + i + '\').click()">ğŸ“· ì—…ë¡œë“œ</button>';
    html += '</div>';
  }
  grid.innerHTML = html;
  
  // ê¸°ì¡´ ì´ë¯¸ì§€ ë¡œë“œ
  for(var i = 1; i <= maxChars; i++){
    loadThumb(i);
    setupThumbInput(i);
  }
}

async function loadThumb(charId){
  var preview = document.getElementById('thumbPreview' + charId);
  var card = preview.parentElement;
  
  var { data } = supabase.storage.from('thumbs').getPublicUrl('char_' + charId + '.jpg');
  
  var img = new Image();
  img.onload = function(){
    preview.innerHTML = '<img src="' + data.publicUrl + '?' + Date.now() + '"><button class="delete-btn" onclick="deleteThumb(' + charId + ')">âœ•</button>';
    card.classList.add('has-image');
  };
  img.onerror = function(){
    // png ì‹œë„
    var { data: data2 } = supabase.storage.from('thumbs').getPublicUrl('char_' + charId + '.png');
    var img2 = new Image();
    img2.onload = function(){
      preview.innerHTML = '<img src="' + data2.publicUrl + '?' + Date.now() + '"><button class="delete-btn" onclick="deleteThumb(' + charId + ')">âœ•</button>';
      card.classList.add('has-image');
    };
    img2.src = data2.publicUrl;
  };
  img.src = data.publicUrl;
}

function setupThumbInput(charId){
  document.getElementById('thumbInput' + charId).onchange = async function(e){
    var file = e.target.files[0];
    if(!file) return;
    
    var ext = file.name.split('.').pop().toLowerCase();
    var fileName = 'char_' + charId + '.' + ext;
    
    toast('ì—…ë¡œë“œ ì¤‘...');
    
    // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
    await supabase.storage.from('thumbs').remove(['char_' + charId + '.jpg', 'char_' + charId + '.png']);
    
    var { error } = await supabase.storage.from('thumbs').upload(fileName, file, { upsert: true });
    
    if(error){
      toast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, true);
    } else {
      toast('ì—…ë¡œë“œ ì™„ë£Œ!');
      loadThumb(charId);
    }
  };
}

async function deleteThumb(charId){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  await supabase.storage.from('thumbs').remove(['char_' + charId + '.jpg', 'char_' + charId + '.png']);
  
  var preview = document.getElementById('thumbPreview' + charId);
  preview.innerHTML = '<span class="placeholder">ğŸ‘¤</span>';
  preview.parentElement.classList.remove('has-image');
  toast('ì‚­ì œë¨!');
}

// ìŠ¤í…Œì´ì§€ ì´ë¯¸ì§€
function renderRoundTabs(){
  var tabs = document.getElementById('roundTabs');
  var html = '';
  for(var r = 1; r <= maxRounds; r++){
    html += '<button class="round-tab' + (r === currentRound ? ' active' : '') + '" data-round="' + r + '">ë¼ìš´ë“œ ' + r + '</button>';
  }
  tabs.innerHTML = html;
  
  tabs.querySelectorAll('.round-tab').forEach(function(tab){
    tab.onclick = function(){
      currentRound = parseInt(tab.dataset.round);
      tabs.querySelectorAll('.round-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      renderStages();
    };
  });
}

async function renderStages(){
  var grid = document.getElementById('stagesGrid');
  var html = '';
  
  for(var s = 1; s <= stagesPerRound; s++){
    var key = 'r' + currentRound + '_s' + s;
    html += '<div class="upload-card" data-key="' + key + '">';
    html += '<div class="preview" id="stagePreview_' + key + '"><span class="placeholder">ğŸ¬</span></div>';
    html += '<div class="label">ìŠ¤í…Œì´ì§€ ' + s + '</div>';
    html += '<input type="file" accept="image/*,video/*" id="stageInput_' + key + '">';
    html += '<button class="upload-btn" onclick="document.getElementById(\'stageInput_' + key + '\').click()">ğŸ“· ì—…ë¡œë“œ</button>';
    html += '</div>';
  }
  grid.innerHTML = html;
  
  // ê¸°ì¡´ ì´ë¯¸ì§€ ë¡œë“œ
  for(var s = 1; s <= stagesPerRound; s++){
    var key = 'r' + currentRound + '_s' + s;
    loadStage(key);
    setupStageInput(key);
  }
}

async function loadStage(key){
  var preview = document.getElementById('stagePreview_' + key);
  var card = preview.parentElement;
  
  // jpg, png, mp4 ìˆœì„œë¡œ ì‹œë„
  var exts = ['jpg', 'png', 'mp4'];
  
  for(var ext of exts){
    var { data } = supabase.storage.from('secret').getPublicUrl(key + '.' + ext);
    
    if(ext === 'mp4'){
      // ë¹„ë””ì˜¤ ì²´í¬ëŠ” ë³„ë„ë¡œ
      var video = document.createElement('video');
      video.onloadeddata = function(){
        preview.innerHTML = '<video src="' + data.publicUrl + '?' + Date.now() + '" autoplay muted loop></video><button class="delete-btn" onclick="deleteStage(\'' + key + '\')">âœ•</button>';
        card.classList.add('has-image');
      };
      video.src = data.publicUrl;
    } else {
      var img = new Image();
      img.onload = (function(url, k){
        return function(){
          document.getElementById('stagePreview_' + k).innerHTML = '<img src="' + url + '?' + Date.now() + '"><button class="delete-btn" onclick="deleteStage(\'' + k + '\')">âœ•</button>';
          document.getElementById('stagePreview_' + k).parentElement.classList.add('has-image');
        };
      })(data.publicUrl, key);
      img.src = data.publicUrl;
    }
  }
}

function setupStageInput(key){
  document.getElementById('stageInput_' + key).onchange = async function(e){
    var file = e.target.files[0];
    if(!file) return;
    
    var ext = file.name.split('.').pop().toLowerCase();
    var fileName = key + '.' + ext;
    
    toast('ì—…ë¡œë“œ ì¤‘...');
    
    // ê¸°ì¡´ íŒŒì¼ ì‚­ì œ
    await supabase.storage.from('secret').remove([key + '.jpg', key + '.png', key + '.mp4']);
    
    var { error } = await supabase.storage.from('secret').upload(fileName, file, { upsert: true });
    
    if(error){
      toast('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message, true);
    } else {
      toast('ì—…ë¡œë“œ ì™„ë£Œ!');
      loadStage(key);
    }
  };
}

async function deleteStage(key){
  if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  
  await supabase.storage.from('secret').remove([key + '.jpg', key + '.png', key + '.mp4']);
  
  var preview = document.getElementById('stagePreview_' + key);
  preview.innerHTML = '<span class="placeholder">ğŸ¬</span>';
  preview.parentElement.classList.remove('has-image');
  toast('ì‚­ì œë¨!');
}

function renderStats(){
  var coins = parseInt(localStorage.getItem('nb_coins')) || 0;
  var round = parseInt(localStorage.getItem('nb_round')) || 1;
  var unlocked = JSON.parse(localStorage.getItem('nb_unlocked_chars')) || [1];
  
  document.getElementById('coinInput').value = coins;
  document.getElementById('statsGrid').innerHTML = 
    '<div class="stat-card"><div class="value">' + coins.toLocaleString() + '</div><div class="label">ì½”ì¸</div></div>' +
    '<div class="stat-card"><div class="value">' + round + '</div><div class="label">ë¼ìš´ë“œ</div></div>' +
    '<div class="stat-card"><div class="value">' + unlocked.length + '/' + maxChars + '</div><div class="label">ìºë¦­í„°</div></div>';
}

function toast(msg, isError){
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(function(){ t.className = 'toast'; }, 2500);
}
</script>
</body>
</html>
