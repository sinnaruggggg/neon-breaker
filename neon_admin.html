<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë„¤ì˜¨ ë¸Œë ˆì´ì»¤ - ê´€ë¦¬ì</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--primary:#00f0ff;--secondary:#ff00aa;--accent:#ffdd00;--success:#00ff88;--danger:#ff4466;--bg:#0a0a12;--card:#12121f;--text:#fff;--text-dim:#7788aa}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);font-family:'Rajdhani',sans-serif;color:var(--text);min-height:100vh;padding:15px}
    .container{max-width:900px;margin:0 auto}
    h1{font-family:'Orbitron';font-size:22px;text-align:center;margin-bottom:6px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .subtitle{text-align:center;color:var(--text-dim);margin-bottom:20px;font-size:12px}
    .status-bar{padding:10px;background:#0a0a12;border-radius:8px;margin-bottom:15px;font-size:11px;display:flex;align-items:center;gap:10px}
    .status-dot{width:10px;height:10px;border-radius:50%;background:var(--danger)}
    .status-dot.ok{background:var(--success)}
    .tabs{display:flex;gap:5px;margin-bottom:15px;flex-wrap:wrap;justify-content:center}
    .tab{padding:10px 18px;background:var(--card);border:2px solid #2a2a40;border-radius:8px;font-family:'Orbitron';font-size:10px;color:var(--text-dim);cursor:pointer}
    .tab:hover{border-color:var(--primary)}
    .tab.active{background:var(--primary);color:#000;border-color:var(--primary)}
    .panel{display:none;background:var(--card);border:2px solid #2a2a40;border-radius:12px;padding:15px}
    .panel.active{display:block}
    .section{margin-bottom:18px}
    .section-title{font-family:'Orbitron';font-size:12px;color:var(--secondary);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(255,0,170,0.2);display:flex;justify-content:space-between;align-items:center}
    .btn{padding:8px 16px;font-family:'Orbitron';font-size:10px;border:none;border-radius:6px;cursor:pointer}
    .btn-sm{padding:5px 10px;font-size:9px}
    .btn-primary{background:var(--primary);color:#000}
    .btn-success{background:var(--success);color:#000}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:transparent;border:1px solid #2a2a40;color:var(--text-dim)}
    .row{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
    .input{padding:8px 12px;background:#0a0a12;border:1px solid #2a2a40;border-radius:6px;color:#fff;font-size:12px;width:100%}
    .input-sm{padding:5px 8px;font-size:11px}
    textarea.input{min-height:60px;resize:vertical}
    
    /* ë¼ìš´ë“œ ì¹´ë“œ */
    .round-card{background:#0a0a12;border:2px solid #2a2a40;border-radius:10px;padding:12px;margin-bottom:12px}
    .round-card.active{border-color:var(--primary)}
    .round-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer}
    .round-header .round-num{font-family:'Orbitron';font-size:14px;color:var(--primary);min-width:30px}
    .round-header .round-name{flex:1}
    .round-content{display:none;padding-top:10px;border-top:1px solid #2a2a40}
    .round-card.active .round-content{display:block}
    
    /* ìŠ¤í…Œì´ì§€ ê·¸ë¦¬ë“œ */
    .stage-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:10px}
    .stage-card{background:#151520;border:2px solid #2a2a40;border-radius:8px;padding:10px}
    .stage-card.has-image{border-color:var(--success)}
    .stage-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .stage-num{font-family:'Orbitron';font-size:11px;color:var(--accent)}
    .stage-preview{width:100%;height:70px;background:#050508;border-radius:6px;margin-bottom:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
    .stage-preview img,.stage-preview video{width:100%;height:100%;object-fit:cover}
    .stage-preview .placeholder{color:#333;font-size:20px}
    .stage-preview .delete-btn{position:absolute;top:4px;right:4px;width:18px;height:18px;background:var(--danger);border:none;border-radius:50%;color:#fff;font-size:9px;cursor:pointer;display:none}
    .stage-card:hover .delete-btn{display:block}
    .stage-card input[type="file"]{display:none}
    .stage-card .upload-btn{width:100%;padding:5px;background:var(--primary);border:none;border-radius:5px;font-family:'Orbitron';font-size:8px;color:#000;cursor:pointer;margin-bottom:6px}
    .stage-card textarea{width:100%;padding:5px;background:#0a0a12;border:1px solid #2a2a40;border-radius:4px;color:#fff;font-size:10px;resize:none;height:40px}
    
    /* ë°ì´í„° */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-bottom:12px}
    .stat-card{background:#0a0a12;border:1px solid #2a2a40;border-radius:8px;padding:10px;text-align:center}
    .stat-card .value{font-family:'Orbitron';font-size:18px;color:var(--accent)}
    .stat-card .label{font-size:9px;color:var(--text-dim)}
    
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(100px);padding:10px 20px;background:rgba(0,0,0,0.95);border:1px solid var(--success);border-radius:20px;font-family:'Orbitron';font-size:10px;color:var(--success);opacity:0;transition:all 0.3s;z-index:999}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .toast.error{border-color:var(--danger);color:var(--danger)}
  </style>
</head>
<body>
  <div class="container">
    <h1>âš™ï¸ ë„¤ì˜¨ ë¸Œë ˆì´ì»¤ ê´€ë¦¬ì</h1>
    <p class="subtitle">ë¼ìš´ë“œ/ìŠ¤í…Œì´ì§€/ìŠ¤í† ë¦¬ ê´€ë¦¬</p>
    
    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">ì—°ê²° ì¤‘...</span>
      <button class="btn btn-sm btn-primary" onclick="saveAllData()" style="margin-left:auto">ğŸ’¾ ì „ì²´ ì €ì¥</button>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="rounds">ğŸ® ë¼ìš´ë“œ/ìŠ¤í…Œì´ì§€</button>
      <button class="tab" data-tab="data">ğŸ’¾ ë°ì´í„°</button>
    </div>

    <!-- Rounds Panel -->
    <div class="panel active" id="roundsPanel">
      <div class="section">
        <div class="section-title">
          <span>ğŸ® ë¼ìš´ë“œ ê´€ë¦¬</span>
          <button class="btn btn-sm btn-success" onclick="addRound()">+ ë¼ìš´ë“œ ì¶”ê°€</button>
        </div>
        <div id="roundsList"></div>
      </div>
    </div>

    <!-- Data Panel -->
    <div class="panel" id="dataPanel">
      <div class="section">
        <div class="section-title"><span>ğŸ“Š ê²Œì„ ë°ì´í„°</span></div>
        <div class="stats-grid" id="statsGrid"></div>
      </div>
      <div class="section">
        <div class="section-title"><span>ğŸ’° ì½”ì¸</span></div>
        <div class="row">
          <input type="number" class="input" id="coinInput" style="width:100px;">
          <button class="btn btn-primary" onclick="setCoins()">ì„¤ì •</button>
          <button class="btn btn-ghost" onclick="addCoins(1000)">+1ì²œ</button>
          <button class="btn btn-ghost" onclick="addCoins(10000)">+1ë§Œ</button>
        </div>
      </div>
      <div class="section">
        <div class="section-title"><span>âš ï¸ ìœ„í—˜</span></div>
        <div class="row">
          <button class="btn btn-primary" onclick="unlockAll()">ğŸ”“ ì „ì²´ í•´ê¸ˆ</button>
          <button class="btn btn-danger" onclick="resetData()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

<script>
var SUPABASE_URL = 'https://ealukkcyetnoouslojaa.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhbHVra2N5ZXRub291c2xvamFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5ODkwNjAsImV4cCI6MjA4NDU2NTA2MH0.SQ77IL13Da3FczDKEtEcHwkQCRDKCA1-RaTBjQ5SvE0';

var sb;
var activeRound = 1;

// ë¼ìš´ë“œ/ìŠ¤í…Œì´ì§€ ë°ì´í„°
var gameData = {
  rounds: [
    {id:1, name:'ì±•í„° 1: ì‹œì‘', stages:[
      {id:1, text:'ìƒˆë¡œìš´ ëª¨í—˜ì´ ì‹œì‘ë©ë‹ˆë‹¤...'},
      {id:2, text:''},
      {id:3, text:''},
      {id:4, text:''},
      {id:5, text:''},
      {id:6, text:''},
      {id:7, text:'ë³´ìŠ¤ê°€ ë‚˜íƒ€ë‚¬ë‹¤!'}
    ]},
    {id:2, name:'ì±•í„° 2: ê°ì„±', stages:[
      {id:1, text:''},{id:2, text:''},{id:3, text:''},{id:4, text:''},{id:5, text:''},{id:6, text:''},{id:7, text:''}
    ]},
    {id:3, name:'ì±•í„° 3: ì‹œë ¨', stages:[
      {id:1, text:''},{id:2, text:''},{id:3, text:''},{id:4, text:''},{id:5, text:''},{id:6, text:''},{id:7, text:''}
    ]}
  ]
};

window.onload = async function(){
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  loadGameData();
  await checkConnection();
  setupTabs();
  renderRounds();
  renderStats();
};

function loadGameData(){
  var saved = localStorage.getItem('nb_gamedata');
  if(saved) gameData = JSON.parse(saved);
}

function saveGameData(){
  localStorage.setItem('nb_gamedata', JSON.stringify(gameData));
}

async function checkConnection(){
  try {
    var { data, error } = await sb.storage.from('thumbs').list();
    if(error) throw error;
    document.getElementById('statusDot').classList.add('ok');
    document.getElementById('statusText').textContent = 'Supabase ì—°ê²°ë¨ âœ“';
  } catch(e) {
    document.getElementById('statusText').textContent = 'ì—°ê²° ì‹¤íŒ¨: ' + e.message;
  }
}

function setupTabs(){
  document.querySelectorAll('.tab').forEach(function(tab){
    tab.onclick = function(){
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + 'Panel').classList.add('active');
    };
  });
}

// ===== ë¼ìš´ë“œ ê´€ë¦¬ =====
function renderRounds(){
  var html = '';
  gameData.rounds.forEach(function(round, idx){
    var isActive = round.id === activeRound;
    html += '<div class="round-card' + (isActive ? ' active' : '') + '" data-round="' + round.id + '">';
    html += '<div class="round-header" onclick="toggleRound(' + round.id + ')">';
    html += '<span class="round-num">R' + round.id + '</span>';
    html += '<input type="text" class="input input-sm round-name" value="' + round.name + '" onclick="event.stopPropagation()" onchange="updateRoundName(' + round.id + ', this.value)">';
    html += '<button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteRound(' + round.id + ')">ì‚­ì œ</button>';
    html += '</div>';
    html += '<div class="round-content">';
    html += '<div class="row"><button class="btn btn-sm btn-success" onclick="addStage(' + round.id + ')">+ ìŠ¤í…Œì´ì§€ ì¶”ê°€</button></div>';
    html += '<div class="stage-grid">';
    round.stages.forEach(function(stage){
      var key = 'r' + round.id + '_s' + stage.id;
      html += '<div class="stage-card" id="stageCard_' + key + '">';
      html += '<div class="stage-header"><span class="stage-num">S' + stage.id + '</span>';
      html += '<button class="btn btn-sm btn-danger" onclick="deleteStage(' + round.id + ',' + stage.id + ')">X</button></div>';
      html += '<div class="stage-preview" id="stagePrev_' + key + '"><span class="placeholder">ğŸ¬</span></div>';
      html += '<input type="file" accept="image/*,video/*" id="stageInput_' + key + '" onchange="uploadStage(\'' + key + '\')">';
      html += '<button class="upload-btn" onclick="document.getElementById(\'stageInput_' + key + '\').click()">ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>';
      html += '<textarea placeholder="ìŠ¤í† ë¦¬ í…ìŠ¤íŠ¸..." onchange="updateStageText(' + round.id + ',' + stage.id + ',this.value)">' + (stage.text || '') + '</textarea>';
      html += '</div>';
    });
    html += '</div></div></div>';
  });
  document.getElementById('roundsList').innerHTML = html;
  
  // ì´ë¯¸ì§€ ë¡œë“œ
  gameData.rounds.forEach(function(round){
    round.stages.forEach(function(stage){
      loadStageImage('r' + round.id + '_s' + stage.id);
    });
  });
}

function toggleRound(id){
  activeRound = (activeRound === id) ? null : id;
  renderRounds();
}

function addRound(){
  var newId = gameData.rounds.length > 0 ? Math.max(...gameData.rounds.map(r => r.id)) + 1 : 1;
  gameData.rounds.push({
    id: newId,
    name: 'ì±•í„° ' + newId,
    stages: [
      {id:1, text:''},{id:2, text:''},{id:3, text:''},{id:4, text:''},{id:5, text:''},{id:6, text:''},{id:7, text:''}
    ]
  });
  saveGameData();
  activeRound = newId;
  renderRounds();
  toast('ë¼ìš´ë“œ ì¶”ê°€ë¨!');
}

function deleteRound(id){
  if(gameData.rounds.length <= 1){ toast('ìµœì†Œ 1ê°œ í•„ìš”!', true); return; }
  if(!confirm('ë¼ìš´ë“œ ' + id + ' ì‚­ì œ?')) return;
  gameData.rounds = gameData.rounds.filter(r => r.id !== id);
  saveGameData();
  renderRounds();
  toast('ì‚­ì œë¨!');
}

function updateRoundName(id, name){
  var round = gameData.rounds.find(r => r.id === id);
  if(round) round.name = name;
  saveGameData();
}

// ===== ìŠ¤í…Œì´ì§€ ê´€ë¦¬ =====
function addStage(roundId){
  var round = gameData.rounds.find(r => r.id === roundId);
  if(!round) return;
  var newId = round.stages.length > 0 ? Math.max(...round.stages.map(s => s.id)) + 1 : 1;
  round.stages.push({id: newId, text: ''});
  saveGameData();
  renderRounds();
  toast('ìŠ¤í…Œì´ì§€ ì¶”ê°€ë¨!');
}

function deleteStage(roundId, stageId){
  var round = gameData.rounds.find(r => r.id === roundId);
  if(!round) return;
  if(round.stages.length <= 1){ toast('ìµœì†Œ 1ê°œ í•„ìš”!', true); return; }
  round.stages = round.stages.filter(s => s.id !== stageId);
  saveGameData();
  renderRounds();
  toast('ì‚­ì œë¨!');
}

function updateStageText(roundId, stageId, text){
  var round = gameData.rounds.find(r => r.id === roundId);
  if(!round) return;
  var stage = round.stages.find(s => s.id === stageId);
  if(stage) stage.text = text;
  saveGameData();
}

// ===== ì´ë¯¸ì§€ ì—…ë¡œë“œ =====
async function loadStageImage(key){
  try {
    var { data } = await sb.storage.from('secret').list();
    var file = data.find(f => f.name.startsWith(key + '.'));
    if(file){
      var { data: urlData } = sb.storage.from('secret').getPublicUrl(file.name);
      var prev = document.getElementById('stagePrev_' + key);
      var card = document.getElementById('stageCard_' + key);
      if(!prev || !card) return;
      var isVideo = file.name.endsWith('.mp4') || file.name.endsWith('.webm');
      if(isVideo){
        prev.innerHTML = '<video src="' + urlData.publicUrl + '?' + Date.now() + '" autoplay muted loop></video><button class="delete-btn" onclick="deleteStageImage(\'' + key + '\',\'' + file.name + '\')">âœ•</button>';
      } else {
        prev.innerHTML = '<img src="' + urlData.publicUrl + '?' + Date.now() + '"><button class="delete-btn" onclick="deleteStageImage(\'' + key + '\',\'' + file.name + '\')">âœ•</button>';
      }
      card.classList.add('has-image');
    }
  } catch(e){}
}

async function uploadStage(key){
  var input = document.getElementById('stageInput_' + key);
  var file = input.files[0];
  if(!file) return;
  
  toast('ì—…ë¡œë“œ ì¤‘...');
  
  try {
    var { data: list } = await sb.storage.from('secret').list();
    var old = list.filter(f => f.name.startsWith(key + '.'));
    if(old.length) await sb.storage.from('secret').remove(old.map(f => f.name));
    
    var ext = file.name.split('.').pop();
    var { error } = await sb.storage.from('secret').upload(key + '.' + ext, file);
    
    if(error) throw error;
    toast('ì™„ë£Œ!');
    loadStageImage(key);
  } catch(e){
    toast('ì‹¤íŒ¨: ' + e.message, true);
  }
}

async function deleteStageImage(key, name){
  await sb.storage.from('secret').remove([name]);
  var prev = document.getElementById('stagePrev_' + key);
  var card = document.getElementById('stageCard_' + key);
  if(prev) prev.innerHTML = '<span class="placeholder">ğŸ¬</span>';
  if(card) card.classList.remove('has-image');
  toast('ì‚­ì œë¨');
}

// ===== ë°ì´í„° =====
function renderStats(){
  var coins = parseInt(localStorage.getItem('nb_coins')) || 0;
  var round = parseInt(localStorage.getItem('nb_round')) || 1;
  document.getElementById('coinInput').value = coins;
  document.getElementById('statsGrid').innerHTML = 
    '<div class="stat-card"><div class="value">' + coins.toLocaleString() + '</div><div class="label">ì½”ì¸</div></div>' +
    '<div class="stat-card"><div class="value">' + round + '</div><div class="label">ë¼ìš´ë“œ</div></div>' +
    '<div class="stat-card"><div class="value">' + gameData.rounds.length + '</div><div class="label">ì´ ë¼ìš´ë“œ</div></div>';
}

function setCoins(){
  var v = parseInt(document.getElementById('coinInput').value) || 0;
  localStorage.setItem('nb_coins', v);
  renderStats();
  toast('ì„¤ì •ë¨!');
}

function addCoins(n){
  var v = (parseInt(localStorage.getItem('nb_coins')) || 0) + n;
  localStorage.setItem('nb_coins', v);
  document.getElementById('coinInput').value = v;
  renderStats();
  toast('+' + n.toLocaleString());
}

function unlockAll(){
  var up = {w1:10,w2:10,w3:10,w4:10,s1:5,s2:5,s3:5,s4:5,p_width:10,p_magnet:5,p_catch:5,p_speed:10,p_multi:3,b_dmg:10,b_speed:5,b_size:5};
  localStorage.setItem('nb_upgrades', JSON.stringify(up));
  localStorage.setItem('nb_coins', 99999);
  renderStats();
  toast('ì „ì²´ í•´ê¸ˆ!');
}

function resetData(){
  if(confirm('ì´ˆê¸°í™”?')){ localStorage.clear(); location.reload(); }
}

function saveAllData(){
  saveGameData();
  toast('ì „ì²´ ì €ì¥ ì™„ë£Œ!');
}

function toast(msg, err){
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (err ? ' error' : '');
  setTimeout(function(){ t.className = 'toast'; }, 2000);
}
</script>
</body>
</html>
